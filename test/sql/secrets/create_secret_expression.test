# name: test/sql/secrets/create_secret_expression.test
# description: Test secrets with expressions as params
# group: [secrets]

require noforcestorage

statement ok
PRAGMA enable_verification;

statement ok
set allow_parser_override_extension=strict;

statement ok
CREATE SECRET a (TYPE http);

statement error
CREATE SECRET a (TYPE http);
----
Invalid Input Error: Temporary secret with name 'a' already exists!

statement ok
CREATE PERSISTENT SECRET a (TYPE http);

statement ok
CREATE PERSISTENT SECRET b (TYPE http);

statement error
CREATE PERSISTENT SECRET b (TYPE http);
----
Invalid Input Error: Persistent secret with name 'b' already exists in secret storage 'local_file'!

statement ok
CREATE OR REPLACE SECRET a (TYPE http);

statement ok
CREATE SECRET IF NOT EXISTS a (TYPE http);

statement error
CREATE OR REPLACE SECRET IF NOT EXISTS a (TYPE http);
----
Parser Error

statement ok
CREATE TABLE bearer_tokens AS SELECT 'blablab'

statement ok
SET VARIABLE my_bearer_token='hocus pocus this token is bogus';

statement ok
CREATE SECRET http (TYPE HTTP, BEARER_TOKEN getvariable('my_bearer_token'));

query I
SELECT secret_string.split(';')[-1] FROM duckdb_secrets() where name='http';
----
bearer_token=hocus pocus this token is bogus

# Test "old" syntax from before expressions were allowed
statement ok
CREATE SECRET scope_as_struct (TYPE HTTP, BEARER_TOKEN some_field, scope ('hi', 'hello'));

query I
select scope from duckdb_secrets() where name='scope_as_struct'
----
[hi, hello]
