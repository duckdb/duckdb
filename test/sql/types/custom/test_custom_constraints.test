# name: test/sql/types/custom/test_custom_constraints.test
# description: CUSTOM tests on table constraints
# group: [custom]

statement ok
PRAGMA enable_verification

statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box
);

# We can't drop mood because person depends on it
statement error
drop type box

# But if we drop person
statement ok
drop table person

# We can drop mood
statement ok
drop type box

# We can recreate all of them again
statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box
);

#Cascading drops (i.e. DROP TYPE box CASCADE)
statement ok
DROP TYPE box CASCADE

#DROP TYPE after we alter the table so the dependency is gone (ALTER)
statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box
);

statement ok
ALTER TABLE person ALTER current_box SET DATA TYPE VARCHAR

statement ok
DROP TYPE box

statement ok
DROP TABLE person

#DROP TYPE after we alter the table so the dependency is gone (DROP COLUMN)
statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box
);

statement ok
ALTER TABLE person DROP COLUMN current_box

statement ok
DROP TYPE box

statement ok
DROP TABLE person

#Dependencies introduced by alter statements, i.e. ADD COLUMN with ENUM type
statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text
);

statement ok
ALTER TABLE person ADD COLUMN current_box box

statement error
DROP TYPE box

#Dropping the table and type in the same transaction
statement ok
BEGIN TRANSACTION;

statement ok
DROP TABLE person

statement ok
DROP TYPE box

statement ok
COMMIT;

# Try with two dependencies to the same type ( Delete One column, try do delete type, change type of the other column,
# delete type, recreate type, add column with type, try to delete type)
statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    past_box box,
    current_box box
);

statement ok
ALTER TABLE person DROP COLUMN current_box

statement error
DROP TYPE box

statement ok
ALTER TABLE person ALTER past_box SET DATA TYPE VARCHAR

statement ok
DROP TYPE box

statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
ALTER TABLE person ADD COLUMN current_box box

statement error
DROP TYPE box

# Clean-up
statement ok
DROP TABLE person

statement ok
DROP TYPE box

# Transactions with rollbacks
statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box
);

statement ok
BEGIN TRANSACTION;


statement ok
ALTER TABLE person ALTER current_box SET DATA TYPE VARCHAR;

statement ok
ROLLBACK;

#Fails, box should still be dependent on by the table
statement error
DROP TYPE box;


#CLEANUP
statement ok
DROP TABLE person;

statement ok
DROP TYPE box;

statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box
);


statement ok
BEGIN TRANSACTION;


statement ok
ALTER TABLE person DROP COLUMN current_box

statement ok
ROLLBACK;

#Fails, box should still be dependent on by the table
statement error
DROP TYPE box;

#CLEANUP
statement ok
DROP TABLE person;

statement ok
DROP TYPE box;

statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text );

statement ok
BEGIN TRANSACTION;

statement ok
ALTER TABLE person ADD COLUMN current_box box

statement ok
ROLLBACK;

statement ok
DROP TYPE box;

statement ok
DROP TABLE person

# Test Column Rename

statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box
);

statement ok
ALTER TABLE person RENAME COLUMN current_box TO past_box

# Check if constraint still there
statement error
DROP TYPE box

statement ok
DROP TABLE person

statement ok
DROP TYPE box


# Test Table Multiple Columns Same Type

statement ok
CREATE TYPE box (input := 'to_base64', output := 'from_base64');

statement ok
CREATE TABLE person (
    name text,
    current_box box,
    past_box box
);

# Check if constraint still there
statement error
DROP TYPE box

statement ok
ALTER TABLE person DROP COLUMN current_box

statement error
DROP TYPE box

statement ok
DROP TABLE person

statement ok
DROP TYPE box
