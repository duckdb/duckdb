# name: test/sql/types/geo/geometry_shred_checkpoint.test_slow
# description: Test consecutive concurrent checkpoints
# group: [geo]

statement ok
SET geometry_minimum_shredding_size = 0;

statement ok
SET checkpoint_threshold='1TB'

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET debug_checkpoint_sleep_ms=100

statement ok
ATTACH '__TEST_DIR__/geometry_shred_concurrent_checkpoint.db' AS concurrent_checkpoint_wal (STORAGE_VERSION 'v1.5.0')

statement ok
CREATE TABLE concurrent_checkpoint_wal.t1(g GEOMETRY)

loop iteration 0 10

concurrentloop threadid 0 20

loop x 0 10

onlyif threadid<>10
statement ok
INSERT INTO concurrent_checkpoint_wal.t1 SELECT printf('POINT(%d %d)', i, i)::GEOMETRY
FROM range(${threadid} * 100, (${threadid} + 1) * 100) as r(i);

endloop

onlyif threadid=10
statement ok
CHECKPOINT concurrent_checkpoint_wal

endloop

endloop

query I
SELECT COUNT(*) FROM concurrent_checkpoint_wal.t1
----
190000

statement ok
DETACH concurrent_checkpoint_wal

statement ok
ATTACH '__TEST_DIR__/geometry_shred_concurrent_checkpoint.db' AS concurrent_checkpoint_wal

query I
SELECT COUNT(*) FROM concurrent_checkpoint_wal.t1
----
190000

statement ok
DETACH concurrent_checkpoint_wal
