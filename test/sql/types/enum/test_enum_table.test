# name: test/sql/types/enum/test_enum_table.test
# description: ENUM types used in table tests
# group: [enum]

statement ok
PRAGMA enable_verification

statement ok
CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');

# Test with non existent enum type
statement error
CREATE TABLE person (
    name text,
    current_car car
);

statement ok
CREATE TABLE person (
    name text,
    current_mood mood
);

statement ok
INSERT INTO person VALUES ('Moe', 'happy');

statement error
INSERT INTO person VALUES ('Moe', 'diego');

query TT
select * from person
----
Moe	happy

statement ok
INSERT INTO person VALUES ('Pedro', 'ok');

statement ok
INSERT INTO person VALUES ('Mark', 'sad');

query TT
select * from person where current_mood = 'sad'
----
Mark	sad

query TT
select * from person where current_mood > 'sad'
----
Moe	happy
Pedro	ok

statement ok
CREATE TABLE pets (
    name text,
    current_mood mood
);

statement ok
INSERT INTO pets VALUES ('Anne', 'happy');

statement ok
INSERT INTO pets VALUES ('Oogie Boogie', 'ok');

#Null Values in the column are allowed
statement ok
INSERT INTO pets VALUES ('Mr. Fluffles McFluffingstein', NULL);

query TT
select * from pets;
----
Anne	happy
Oogie Boogie	ok
Mr. Fluffles McFluffingstein	NULL

query TT
select person.name, pets.name from person inner join pets on  (person.current_mood = pets.current_mood)
----
Moe	Anne
Pedro	Oogie Boogie

statement ok
DROP TYPE mood;

# Tables should still function

query TT
select person.name, pets.name from person inner join pets on  (person.current_mood = pets.current_mood)
----
Moe	Anne
Pedro	Oogie Boogie

# Creating a new table should not
statement error
CREATE TABLE aliens (
    name text,
    current_mood mood
);

statement ok
CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');

statement ok
CREATE TYPE intelligence AS ENUM ('dumb', 'smart', 'ehh');

statement ok
CREATE TABLE aliens (
    name text,
    current_mood mood
);

# ALTER TABLE ADD COLUMN with the enum type (see test/sql/alter/add_col/test_add_col.test)

statement ok
INSERT INTO aliens VALUES ('Alf o Eteimoso', 'happy'), ('Dr Zoidberg', 'sad')

statement ok
ALTER TABLE aliens ADD COLUMN iq_level intelligence

query III
select * from aliens
----
Alf o Eteimoso	happy	NULL
Dr Zoidberg	sad	NULL

statement ok
INSERT INTO aliens VALUES ('The Borg', 'ok', 'ehh')

query III
select * from aliens
----
Alf o Eteimoso	happy	NULL
Dr Zoidberg	sad	NULL
The Borg	ok	ehh

# ALTER TABLE SET DATA TYPE with the enum type (see test/sql/alter/alter_type/test_alter_type.test)
statement ok
ALTER TABLE aliens ALTER current_mood SET DATA TYPE VARCHAR

query III
select * from aliens
----
Alf o Eteimoso	happy	NULL
Dr Zoidberg	sad	NULL
The Borg	ok	ehh

# Comparisons between enum columns with the same enum type
statement ok
CREATE TYPE car_brand AS ENUM ('Tesla', 'VW', 'Seat', 'Fiets');

statement ok
DROP TABLE person

statement ok
CREATE TABLE person (
    name text,
    current_mood mood,
    last_year_mood mood,
    car car_brand
);

statement ok
INSERT INTO person VALUES ('Pedro', 'ok', 'ok','Seat'), ('Mark', 'sad', 'happy','Fiets');

query IIII
select * from person where current_mood = last_year_mood
----
Pedro	ok	ok	Seat

# Comparisons between enums and strings

query IIII
select * from person where current_mood = 'ok'
----
Pedro	ok	ok	Seat

# Comparison between two different enum types (Unimplemented type for cast (car_brand -> mood))
statement error
select * from person where current_mood = car

#GROUP BY and ORDER BY on enums, both as keys and in the payload
statement ok
INSERT INTO person VALUES ('Diego', 'sad', 'happy','Seat'), ('Tim', 'happy', 'sad','Fiets');

query II
select count(*), current_mood from person group by current_mood
----
1	ok
2	sad
1	happy

query II
select name, current_mood from person order by current_mood
----
Mark	sad
Diego	sad
Pedro	ok
Tim	happy

#Explicit CAST and TRY_CAST from enum -> string
query I
SELECT CAST (current_mood as STRING) from person
----
ok
sad
sad
happy

query I
SELECT TRY_CAST (current_mood as STRING) from person
----
ok
sad
sad
happy

#Explicit CAST and TRY_CAST from string -> enum (note that try_cast should return NULL instead of throwing an exception if the cast fails)
query I
SELECT CAST ('ok' as mood)
----
ok

query I
SELECT TRY_CAST ('ok' as mood)
----
ok

statement error
SELECT CAST ('bla' as mood)
----
ok

query I
SELECT TRY_CAST ('bla' as mood)
----
NULL


# Create an enum
statement ok
create type breed AS ENUM ('Maltese', 'Shi-tzu', 'Samoyed', 'Robot');

# Create a table with that enum
statement ok
CREATE TABLE dog (
    name text,
    type breed
);

statement ok
INSERT INTO dog VALUES ('Oogie Boogie', 'Maltese'), ('Anne', 'Shi-tzu'),('Blaster', 'Samoyed'), ('Roomba', 'Robot')

#drop the enum
statement ok
drop type breed

#create the same enum again,
statement ok
create type breed AS ENUM ('Maltese', 'Shi-tzu', 'Samoyed', 'Robot');

#create a new table with the new enum,
statement ok
CREATE TABLE dog_2 (
    name text,
    type breed
);

statement ok
INSERT INTO dog_2 VALUES ('Teddy', 'Samoyed')

#then compare between the two tables. What should happen?

query IIII
select * from dog_2 inner join dog on (dog_2.type = dog.type);
----
Teddy	Samoyed	Blaster	Samoyed

#drop the enum
statement ok
drop type breed

#create a diffferent enum
statement ok
create type breed AS ENUM ('Golden', 'Pomeranian');

statement ok
CREATE TABLE dog_3 (
    name text,
    type breed
);

statement ok
INSERT INTO dog_3 VALUES ('Licity', 'Golden')

# This should break because the enums are different (Although have the same name)
statement error
select * from dog_3 inner join dog on (dog_3.type = dog.type);

