# name: test/sql/types/struct/nested_struct_projection_pushdown.test
# description: Test nested struct projection pushdown
# group: [struct]

load __TEST_DIR__/nested_struct_projection_pushdown.db

require parquet

# Always shred
statement ok
SET variant_minimum_shredding_size = 0;

statement ok
PRAGMA enable_verification

foreach type struct variant

# 2 layers of nesting

onlyif type=struct
statement ok
CREATE OR REPLACE TABLE test_structs(
	id INT,
	s STRUCT(
		name STRUCT(
			v VARCHAR,
			id INT
		),
		nested_struct STRUCT(
			a integer,
			b bool
		)
	)
);

onlyif type=variant
statement ok
CREATE OR REPLACE TABLE test_structs(
	id INT,
	s VARIANT
);

statement ok
INSERT INTO test_structs
VALUES (1, {'name': {'v': 'Row 1', 'id': 1}, 'nested_struct': {'a': 42, 'b': true}}),
       (2, NULL),
       (3, {'name': {'v': 'Row 3', 'id': 3}, 'nested_struct': {'a': 84, 'b': NULL}}),
       (4, {'name': NULL, 'nested_struct': {'a': NULL, 'b': false}});

statement ok
checkpoint

restart

statement ok
COPY test_structs TO '__TEST_DIR__/test_structs.parquet'

foreach source test_structs read_parquet('__TEST_DIR__/test_structs.parquet')

query I
SELECT s.nested_struct FROM ${source}
----
{'a': 42, 'b': true}
NULL
{'a': 84, 'b': NULL}
{'a': NULL, 'b': false}

# Add a cast to shuffle the fields
query I
SELECT s.nested_struct::STRUCT(b BOOL, a INTEGER) FROM ${source}
----
{'b': true, 'a': 42}
NULL
{'b': NULL, 'a': 84}
{'b': false, 'a': NULL}

# Add a cast to change the types of the shuffled fields
query I
select s.nested_struct::STRUCT(b INTEGER, a BIGINT) from ${source}
----
{'b': 1, 'a': 42}
NULL
{'b': NULL, 'a': 84}
{'b': 0, 'a': NULL}

query I
SELECT s.nested_struct.a FROM ${source}
----
42
NULL
84
NULL

# Add a cast
query I
SELECT s.nested_struct.a::BIGINT FROM ${source}
----
42
NULL
84
NULL

query II
SELECT s.nested_struct.a, s.name.v FROM ${source}
----
42	Row 1
NULL	NULL
84	Row 3
NULL	NULL

query IIIII
SELECT s.nested_struct.a, s.nested_struct.b, s.nested_struct.a, s.nested_struct, id FROM ${source}
----
42	true	42	{'a': 42, 'b': true}	1
NULL	NULL	NULL	NULL	2
84	NULL	84	{'a': 84, 'b': NULL}	3
NULL	false	NULL	{'a': NULL, 'b': false}	4

# Add a cast on the fields
query IIII
SELECT s.nested_struct.a::BIGINT, s.nested_struct.b, s.nested_struct.a::TINYINT, id FROM ${source}
----
42	true	42	1
NULL	NULL	NULL	2
84	NULL	84	3
NULL	false	NULL	4

query II
SELECT s.nested_struct.a, s.nested_struct FROM ${source}
----
42	{'a': 42, 'b': true}
NULL	NULL
84	{'a': 84, 'b': NULL}
NULL	{'a': NULL, 'b': false}

query II
SELECT s.nested_struct, s.nested_struct.a FROM ${source}
----
{'a': 42, 'b': true}	42
NULL	NULL
{'a': 84, 'b': NULL}	84
{'a': NULL, 'b': false}	NULL

# Add a cast
query II
SELECT s.nested_struct, s.nested_struct.a::VARCHAR FROM ${source}
----
{'a': 42, 'b': true}	42
NULL	NULL
{'a': 84, 'b': NULL}	84
{'a': NULL, 'b': false}	NULL

query II
SELECT s.name.id, s.nested_struct.b,  FROM ${source}
----
1	true
NULL	NULL
3	NULL
NULL	false

query I
SELECT s.name.v FROM ${source} WHERE s.nested_struct.b
----
Row 1

# source
endloop

# 3 layers of nesting

onlyif type=struct
statement ok
CREATE OR REPLACE TABLE test_structs_nested(id INT, base STRUCT(s STRUCT(name STRUCT(v VARCHAR, id INT), nested_struct STRUCT(a integer, b bool))));

onlyif type=variant
statement ok
CREATE OR REPLACE TABLE test_structs_nested(id INT, base VARIANT);

statement ok
INSERT INTO test_structs_nested
VALUES (1, {'s': {'name': {'v': 'Row 1', 'id': 1}, 'nested_struct': {'a': 42, 'b': true}}}),
       (2, NULL),
       (3, {'s': {'name': {'v': 'Row 3', 'id': 3}, 'nested_struct': {'a': 84, 'b': NULL}}}),
       (4, {'s': {'name': NULL, 'nested_struct': {'a': NULL, 'b': false}}});

statement ok
checkpoint

restart

statement ok
COPY test_structs_nested TO '__TEST_DIR__/test_structs.parquet'

foreach source test_structs_nested read_parquet('__TEST_DIR__/test_structs.parquet')

query I
SELECT base.s.nested_struct FROM ${source}
----
{'a': 42, 'b': true}
NULL
{'a': 84, 'b': NULL}
{'a': NULL, 'b': false}

query I
SELECT base.s.nested_struct.a FROM ${source}
----
42
NULL
84
NULL

query II
SELECT base.s.nested_struct.a, base.s.name.v FROM ${source}
----
42	Row 1
NULL	NULL
84	Row 3
NULL	NULL

query III
SELECT base.s.nested_struct.a, base.s.nested_struct.b, base.s.nested_struct FROM ${source}
----
42	true	{'a': 42, 'b': true}
NULL	NULL	NULL
84	NULL	{'a': 84, 'b': NULL}
NULL	false	{'a': NULL, 'b': false}

query II
SELECT base.s.nested_struct.a, base.s.nested_struct FROM ${source}
----
42	{'a': 42, 'b': true}
NULL	NULL
84	{'a': 84, 'b': NULL}
NULL	{'a': NULL, 'b': false}

onlyif type=struct
query II
SELECT base.s.nested_struct.a, base.s FROM ${source}
----
42	{'name': {'v': Row 1, 'id': 1}, 'nested_struct': {'a': 42, 'b': true}}
NULL	NULL
84	{'name': {'v': Row 3, 'id': 3}, 'nested_struct': {'a': 84, 'b': NULL}}
NULL	{'name': NULL, 'nested_struct': {'a': NULL, 'b': false}}

onlyif type=variant
query II
SELECT base.s.nested_struct.a, variant_normalize(base.s) FROM ${source}
----
42	{'name': {'id': 1, 'v': Row 1}, 'nested_struct': {'a': 42, 'b': true}}
NULL	NULL
84	{'name': {'id': 3, 'v': Row 3}, 'nested_struct': {'a': 84, 'b': NULL}}
NULL	{'name': NULL, 'nested_struct': {'a': NULL, 'b': false}}

query II
SELECT base.s.nested_struct, base.s.nested_struct.a FROM ${source}
----
{'a': 42, 'b': true}	42
NULL	NULL
{'a': 84, 'b': NULL}	84
{'a': NULL, 'b': false}	NULL

query II
SELECT base.s.name.id, base.s.nested_struct.b,  FROM ${source}
----
1	true
NULL	NULL
3	NULL
NULL	false

query I
SELECT base.s.name.v FROM ${source} WHERE base.s.nested_struct.b
----
Row 1

# source
endloop

# type
endloop
