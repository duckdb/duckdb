# name: test/sql/types/struct/struct_projection_pushdown.test
# description: Test struct projection pushdown
# group: [struct]

load __TEST_DIR__/struct_projection_pushdown.db

require parquet

# Always shred
statement ok
SET variant_minimum_shredding_size = 0;

statement ok
PRAGMA enable_verification

foreach type struct variant

onlyif type=struct
statement ok
CREATE OR REPLACE TABLE test_structs(id INT, s STRUCT(a integer, b bool));

onlyif type=variant
statement ok
CREATE OR REPLACE TABLE test_structs(id INT, s VARIANT);

statement ok
INSERT INTO test_structs VALUES
	(
		1,
		{
			'a': 42,
			'b': true
		}
	),
	(
		2,
		NULL
	),
	(
		3,
		{
			'a': 84,
			'b': NULL
		}
	),
	(
		4,
		{
			'a': NULL,
			'b': false
		}
	);

statement ok
checkpoint

restart

statement ok
COPY test_structs TO '__TEST_DIR__/test_structs.parquet'

foreach source test_structs read_parquet('__TEST_DIR__/test_structs.parquet')

query I
SELECT s.b FROM ${source}
----
true
NULL
NULL
false

# Add a cast on top of the struct extract
query I
SELECT s.b::INTEGER FROM ${source}
----
1
NULL
NULL
0

query I
SELECT s['b'] FROM ${source}
----
true
NULL
NULL
false

query II
SELECT s['b'], s FROM ${source}
----
true	{'a': 42, 'b': true}
NULL	NULL
NULL	{'a': 84, 'b': NULL}
false	{'a': NULL, 'b': false}

# Add a cast
query II
SELECT s['b']::INTEGER, s FROM ${source}
----
1	{'a': 42, 'b': true}
NULL	NULL
NULL	{'a': 84, 'b': NULL}
0	{'a': NULL, 'b': false}

query II
SELECT s.b, s.a FROM ${source}
----
true	42
NULL	NULL
NULL	84
false	NULL

# Add a cast
query II
SELECT s.b::INTEGER, s.a::BIGINT FROM ${source}
----
1	42
NULL	NULL
NULL	84
0	NULL

query I
SELECT s FROM ${source} WHERE s.b
----
{'a': 42, 'b': true}

onlyif type=struct
query I
SELECT a FROM (SELECT UNNEST(s) FROM ${source}) WHERE b
----
42

onlyif type=variant
statement error
SELECT a FROM (SELECT UNNEST(s) FROM ${source}) WHERE b
----
Binder Error: UNNEST() can only be applied to lists, structs and NULL, not VARIANT

onlyif type=struct
query I
SELECT a::BIGINT FROM (SELECT UNNEST(s) FROM ${source}) WHERE b::INTEGER
----
42

query I
SELECT id FROM ${source} WHERE s.b
----
1

endloop

statement ok
UPDATE test_structs SET s={'a': 84, 'b': false} WHERE id=2

query II
SELECT s['b'], s.a FROM test_structs WHERE id=2
----
false	84

endloop
