# name: test/sql/attach/attach_encryption_fallback_readonly.test
# description: Ensure the fallback crypto implementation is read-only
# group: [attach]

require vector_size 2048

load __TEST_DIR__/tmp.db

require no_extension_autoloading "EXPECTED: This tests what happens when autoloading is disabled"

# For the test, we disable auto-loading
statement ok
set autoinstall_known_extensions=false

# First we try to read an encrypted 
statement error
ATTACH 'data/attach_test/encrypted_gcm_key=abcde.db' as enc (ENCRYPTION_KEY 'abcde', ENCRYPTION_CIPHER 'GCM');
----
Invalid Configuration Error: The database is encrypted, but DuckDB currently has a read-only crypto module loaded. Either re-open the database using `ATTACH '..' (READONLY)`, or ensure httpfs is loaded using `LOAD httpfs`.

# It works again by setting READONLY
statement ok
ATTACH 'data/attach_test/encrypted_gcm_key=abcde.db' as enc (ENCRYPTION_KEY 'abcde', ENCRYPTION_CIPHER 'GCM', READ_ONLY);

query I
FROM enc.test ORDER BY value
----
0
1
2
3
4

statement ok
DETACH enc

# Creating a new table will also fail
statement error
ATTACH '__TEST_DIR__/test_write_only.db' as enc (ENCRYPTION_KEY 'abcde', ENCRYPTION_CIPHER 'GCM');
----
Invalid Configuration Error: The database was opened with encryption enabled, but DuckDB currently has a read-only crypto module loaded. Please re-open using READONLY, or ensure httpfs is loaded using `LOAD httpfs`.

# Loading httpfs will solve all problems

require httpfs

statement ok
ATTACH 'data/attach_test/encrypted_gcm_key=abcde.db' as enc (ENCRYPTION_KEY 'abcde', ENCRYPTION_CIPHER 'GCM');

query I
FROM enc.test ORDER BY value
----
0
1
2
3
4

statement ok
DETACH enc

statement ok
ATTACH '__TEST_DIR__/test_write_only.db' as enc (ENCRYPTION_KEY 'abcde', ENCRYPTION_CIPHER 'GCM');

statement ok
CREATE TABLE enc.test AS SELECT 1 as a;

query I
FROM enc.test
----
1
