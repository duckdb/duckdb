# name: test/sql/attach/attach_no_wal_mode.test
# description: Test the NO_WAL recovery mode.
# group: [attach]

require noforcestorage

require skip_reload

# If we enable alternative verification, then we disable checkpointing on shutdown.
# Thus, we'll keep the WAL alive on DETACH, only that now we don't have a WAL.
require no_alternative_verify

statement ok
SET threads = 1;

statement ok
ATTACH '__TEST_DIR__/no_wal_mode.db' AS no_wal_mode (RECOVERY_MODE NO_WAL);

statement ok
CREATE TABLE no_wal_mode.tbl AS SELECT range AS id, 0 AS v FROM range(5_000);

statement ok
UPDATE no_wal_mode.tbl SET v = id;

# We CHECKPOINT on DETACH.

statement ok
DETACH no_wal_mode;

# Verify no WAL creation.

query I
SELECT COUNT(*) FROM glob('__TEST_DIR__/no_wal_mode.db.wal')
----
0

# Ensure that the changes are persisted.

statement ok
ATTACH '__TEST_DIR__/no_wal_mode.db' AS no_wal_mode (RECOVERY_MODE NO_WAL);

query I
SELECT COUNT(*) FROM no_wal_mode.tbl WHERE v = 0;
----
1

statement ok
DETACH no_wal_mode;

# Now test without persisting changes.

statement ok
SET wal_autocheckpoint = '1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
ATTACH '__TEST_DIR__/other_no_wal_mode.db' AS no_wal_mode (RECOVERY_MODE NO_WAL);

statement ok
CREATE TABLE no_wal_mode.tbl AS SELECT range AS id, 0 AS v FROM range(5_000);

statement ok
CHECKPOINT no_wal_mode;

# Perform update that will NOT be persisted.

statement ok
UPDATE no_wal_mode.tbl SET v = id;

# Verify no WAL creation.

query I
SELECT COUNT(*) FROM glob('__TEST_DIR__/other_no_wal_mode.db.wal')
----
0

statement ok
DETACH no_wal_mode;

query I
SELECT COUNT(*) FROM glob('__TEST_DIR__/other_no_wal_mode.db.wal')
----
0

# Ensure that the changes are not present in the no_wal_mode file.

statement ok
ATTACH '__TEST_DIR__/other_no_wal_mode.db' AS no_wal_mode (RECOVERY_MODE NO_WAL);

query I
SELECT COUNT(*) FROM no_wal_mode.tbl WHERE v = 0;
----
5_000
