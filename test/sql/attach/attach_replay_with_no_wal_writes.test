# name: test/sql/attach/attach_replay_with_no_wal_writes.test
# description: Test the NO_WAL_WRITES recovery mode when having a WAL to replay.
# group: [attach]

require noforcestorage

require skip_reload

statement ok
SET threads = 1;

statement ok
SET wal_autocheckpoint = '1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
ATTACH '__TEST_DIR__/wal_writes.db' AS wal_writes;

statement ok
CREATE TABLE wal_writes.tbl AS SELECT range AS id, 0 AS v FROM range(5_000);

statement ok
DETACH wal_writes;

# Ensure that we have a WAL.

query I
SELECT COUNT(*) FROM glob('__TEST_DIR__/wal_writes.db.wal')
----
1

# We'll still replay the WAL, but we won't write to it again after CHECKPOINT.

statement ok
ATTACH '__TEST_DIR__/wal_writes.db' AS wal_writes (RECOVERY_MODE NO_WAL_WRITES);

# Replayed the WAL, but not yet deleted (no CHECKPOINT).
query I
SELECT COUNT(*) FROM glob('__TEST_DIR__/wal_writes.db.wal')
----
1

statement ok
INSERT INTO wal_writes.tbl VALUES (42, 42);

# CHECKPOINT to delete the WAL.

statement ok
CHECKPOINT wal_writes;

query I
SELECT COUNT(*) FROM glob('__TEST_DIR__/wal_writes.db.wal')
----
0

# Ensure (again) that we persisted the table (replayed its creation).

statement ok
UPDATE wal_writes.tbl SET v = id;

# Verify no WAL creation.

query I
SELECT COUNT(*) FROM glob('__TEST_DIR__/wal_writes.db.wal')
----
0
