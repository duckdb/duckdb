# name: test/sql/logging/logging_file_bind_replace.test
# description: Test file-backed log storage with the duckdb_logs() and duckdb_log_contexts() functions
# group: [logging]

require noforcestorage

# Due to different file locking behaviour, this currently fails on windows
require notwindows

# Enable FileSystem logging to single csv file (note that normalize is implicit here)  
statement ok
CALL enable_logging(['QueryLog'], storage_path='__TEST_DIR__/logging_file_bind_replace_log.csv');

# Read some data to trigger FileSystem log
statement ok
SELECT 1 as a

statement ok
FROM duckdb_logs_parsed('FileSystem');

statement ok
CALL disable_logging();

query IIIIII nosort describe_duckdb_logs
DESCRIBE FROM duckdb_logs;
----

query I
SELECT message FROM duckdb_logs_parsed('QueryLog') WHERE starts_with(message, 'SELECT 1');
----
SELECT 1 as a

query I
SELECT message FROM duckdb_logs_parsed('querylog') WHERE starts_with(message, 'SELECT 1');
----
SELECT 1 as a

statement ok
CALL truncate_duckdb_logs();

# Enable FileSystem logging to double csv file  
statement ok
CALL enable_logging(['QueryLog'], storage='file', storage_config={'path': '__TEST_DIR__/logging_file_bind_replace_normalized/', 'normalize': true});

# Trigger log
statement ok
SELECT 1 as b

statement ok
FROM duckdb_logs

statement ok
CALL disable_logging();

query IIIIII nosort describe_duckdb_logs
DESCRIBE FROM duckdb_logs
----

query I
SELECT message FROM duckdb_logs_parsed('QueryLog') WHERE starts_with(message, 'SELECT 1');
----
SELECT 1 as b

statement ok
CALL truncate_duckdb_logs();

# Now rerun with the in-memory storage to ensure everything matches up
statement ok
CALL enable_logging(['QueryLog'], storage='memory');

statement ok
SELECT 1 as c

statement ok
CALL disable_logging();

query IIIIII nosort describe_duckdb_logs
DESCRIBE FROM duckdb_logs
----

query I
SELECT message FROM duckdb_logs_parsed('QueryLog') WHERE starts_with(message, 'SELECT 1');
----
SELECT 1 as c

statement ok
CALL truncate_duckdb_logs();

# Now rerun with all log types enabled 

statement ok
CALL enable_logging(level='trace', storage='memory');

statement ok
SELECT 1 as d

statement ok
CALL disable_logging();

query IIIIII nosort describe_duckdb_logs
DESCRIBE FROM duckdb_logs
----

query I
SELECT message FROM duckdb_logs_parsed('QueryLog') WHERE starts_with(message, 'SELECT 1');
----
SELECT 1 as d
