# name: test/sql/binder/alias_qualification_qualify.test
# description: Test alias.name resolution in QUALIFY clause
# group: [binder]

# basic QUALIFY using a projection alias for a window expression
query II
SELECT a, row_number() OVER (ORDER BY a) AS rn
FROM (VALUES (3),(1),(2)) t(a)
QUALIFY alias.rn <= 2
ORDER BY a;
----
1	1
2	2

# chaining aliases: later alias based on earlier alias and used in QUALIFY
query II
SELECT a + 1 AS x, row_number() OVER (ORDER BY alias.x) AS rx
FROM (VALUES (10),(20),(30)) t(a)
QUALIFY alias.rx = 2
ORDER BY a;
----
21	2

# quoted alias used in QUALIFY
query II
SELECT a AS "MiXeD", row_number() OVER (ORDER BY a) AS r
FROM (VALUES (2),(1)) t(a)
QUALIFY alias.r = 1
ORDER BY a;
----
1	1

# ensure a table actually named `alias` still works and is prioritized
statement ok
CREATE TABLE alias (v INT);

statement ok
INSERT INTO alias VALUES (2), (1), (3);

query II
SELECT v AS x, row_number() OVER (ORDER BY v) r FROM alias
QUALIFY alias.r <= 2
ORDER BY v;
----
1	1
2	2


# Test function chain in QUALIFY
query II
SELECT c1, row_number() over(partition BY c1 order by c2) as rk FROM VALUES ('a', 1), ('b', 2), ('b', 3), ('c', 4) AS t(c1, c2) qualify rk.add(1) > 2
----
b	2


query I
FROM VALUES ('CS', 'Bachelor'), ('CS', 'Bachelor'), ('CS', 'PhD'), ('Math', 'Masters') AS t(c1, c2)
SELECT list(c2) over(partition BY c1) AS "c3"
QUALIFY "c3".len() = 1;
----
[Masters]