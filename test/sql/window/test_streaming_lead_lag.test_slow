# name: test/sql/window/test_streaming_lead_lag.test_slow
# description: Streaming window functions
# group: [window]

statement ok
PRAGMA enable_verification

statement ok
PRAGMA explain_output = PHYSICAL_ONLY;

# Test all data types
query II
EXPLAIN
SELECT 
	lag(COLUMNS(*), 1) OVER (), 
	lead(COLUMNS(*), -1) OVER()
FROM test_all_types()
----
physical_plan	<REGEX>:.*STREAMING_WINDOW.*

query IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
SELECT 
	lag(COLUMNS(*), 1) OVER (), 
	lead(COLUMNS(*), -1) OVER()
FROM test_all_types()
----
NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
false	-128	-32768	-2147483648	-9223372036854775808	-170141183460469231731687303715884105728	0	0	0	0	0	-179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368	5877642-06-25 (BC)	00:00:00	290309-12-22 (BC) 00:00:00	290309-12-22 (BC) 00:00:00	290309-12-22 (BC) 00:00:00	1677-09-22 00:00:00	00:00:00+15:59:59	290309-12-22 (BC) 00:00:00+00	-3.4028235e+38	-1.7976931348623157e+308	-999.9	-99999.9999	-999999999999.999999	-9999999999999999999999999999.9999999999	00000000-0000-0000-0000-000000000000	00:00:00	🦆🦆🦆🦆🦆🦆	thisisalongblob\x00withnullbytes	0010001001011100010101011010111	DUCK_DUCK_ENUM	enum_0	enum_0	[]	[]	[]	[]	[]	[]	[]	{'a': NULL, 'b': NULL}	{'a': NULL, 'b': NULL}	[]	{}	Frank	[NULL, 2, 3]	[a, NULL, c]	[[NULL, 2, 3], NULL, [NULL, 2, 3]]	[[a, NULL, c], NULL, [a, NULL, c]]	[{'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, {'a': NULL, 'b': NULL}]	{'a': [NULL, 2, 3], 'b': [a, NULL, c]}	[[], [42, 999, NULL, NULL, -42], []]	[[NULL, 2, 3], [4, 5, 6], [NULL, 2, 3]]	false	-128	-32768	-2147483648	-9223372036854775808	-170141183460469231731687303715884105728	0	0	0	0	0	-179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368	5877642-06-25 (BC)	00:00:00	290309-12-22 (BC) 00:00:00	290309-12-22 (BC) 00:00:00	290309-12-22 (BC) 00:00:00	1677-09-22 00:00:00	00:00:00+15:59:59	290309-12-22 (BC) 00:00:00+00	-3.4028235e+38	-1.7976931348623157e+308	-999.9	-99999.9999	-999999999999.999999	-9999999999999999999999999999.9999999999	00000000-0000-0000-0000-000000000000	00:00:00	🦆🦆🦆🦆🦆🦆	thisisalongblob\x00withnullbytes	0010001001011100010101011010111	DUCK_DUCK_ENUM	enum_0	enum_0	[]	[]	[]	[]	[]	[]	[]	{'a': NULL, 'b': NULL}	{'a': NULL, 'b': NULL}	[]	{}	Frank	[NULL, 2, 3]	[a, NULL, c]	[[NULL, 2, 3], NULL, [NULL, 2, 3]]	[[a, NULL, c], NULL, [a, NULL, c]]	[{'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, {'a': NULL, 'b': NULL}]	{'a': [NULL, 2, 3], 'b': [a, NULL, c]}	[[], [42, 999, NULL, NULL, -42], []]	[[NULL, 2, 3], [4, 5, 6], [NULL, 2, 3]]
true	127	32767	2147483647	9223372036854775807	170141183460469231731687303715884105727	340282366920938463463374607431768211455	255	65535	4294967295	18446744073709551615	179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368	5881580-07-10	24:00:00	294247-01-10 04:00:54.775806	294247-01-10 04:00:54	294247-01-10 04:00:54.775	2262-04-11 23:47:16.854775806	24:00:00-15:59:59	294247-01-10 04:00:54.775806+00	3.4028235e+38	1.7976931348623157e+308	999.9	99999.9999	999999999999.999999	9999999999999999999999999999.9999999999	ffffffff-ffff-ffff-ffff-ffffffffffff	83 years 3 months 999 days 00:16:39.999999	goo\0se	\x00\x00\x00a	10101	GOOSE	enum_299	enum_69999	[42, 999, NULL, NULL, -42]	[42.0, nan, inf, -inf, NULL, -42.0]	[1970-01-01, infinity, -infinity, NULL, 2022-05-12]	[1970-01-01 00:00:00, infinity, -infinity, NULL, 2022-05-12 16:23:45]	[1970-01-01 00:00:00+00, infinity, -infinity, NULL, 2022-05-12 23:23:45+00]	[🦆🦆🦆🦆🦆🦆, goose, NULL, ]	[[], [42, 999, NULL, NULL, -42], NULL, [], [42, 999, NULL, NULL, -42]]	{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}	{'a': [42, 999, NULL, NULL, -42], 'b': [🦆🦆🦆🦆🦆🦆, goose, NULL, ]}	[{'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, NULL]	{key1=🦆🦆🦆🦆🦆🦆, key2=goose}	5	[4, 5, 6]	[d, e, f]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]	[[d, e, f], [a, NULL, c], [d, e, f]]	[{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, {'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}]	{'a': [4, 5, 6], 'b': [d, e, f]}	[[42, 999, NULL, NULL, -42], [], [42, 999, NULL, NULL, -42]]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]	true	127	32767	2147483647	9223372036854775807	170141183460469231731687303715884105727	340282366920938463463374607431768211455	255	65535	4294967295	18446744073709551615	179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368	5881580-07-10	24:00:00	294247-01-10 04:00:54.775806	294247-01-10 04:00:54	294247-01-10 04:00:54.775	2262-04-11 23:47:16.854775806	24:00:00-15:59:59	294247-01-10 04:00:54.775806+00	3.4028235e+38	1.7976931348623157e+308	999.9	99999.9999	999999999999.999999	9999999999999999999999999999.9999999999	ffffffff-ffff-ffff-ffff-ffffffffffff	83 years 3 months 999 days 00:16:39.999999	goo\0se	\x00\x00\x00a	10101	GOOSE	enum_299	enum_69999	[42, 999, NULL, NULL, -42]	[42.0, nan, inf, -inf, NULL, -42.0]	[1970-01-01, infinity, -infinity, NULL, 2022-05-12]	[1970-01-01 00:00:00, infinity, -infinity, NULL, 2022-05-12 16:23:45]	[1970-01-01 00:00:00+00, infinity, -infinity, NULL, 2022-05-12 23:23:45+00]	[🦆🦆🦆🦆🦆🦆, goose, NULL, ]	[[], [42, 999, NULL, NULL, -42], NULL, [], [42, 999, NULL, NULL, -42]]	{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}	{'a': [42, 999, NULL, NULL, -42], 'b': [🦆🦆🦆🦆🦆🦆, goose, NULL, ]}	[{'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, NULL]	{key1=🦆🦆🦆🦆🦆🦆, key2=goose}	5	[4, 5, 6]	[d, e, f]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]	[[d, e, f], [a, NULL, c], [d, e, f]]	[{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, {'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}]	{'a': [4, 5, 6], 'b': [d, e, f]}	[[42, 999, NULL, NULL, -42], [], [42, 999, NULL, NULL, -42]]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]


query II
EXPLAIN
SELECT 
	lag(COLUMNS(*), -1) OVER(), 
	lead(COLUMNS(*), 1) OVER()
FROM test_all_types()
----
physical_plan	<REGEX>:.*STREAMING_WINDOW.*

query IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
SELECT 
	lag(COLUMNS(*), -1) OVER(), 
	lead(COLUMNS(*), 1) OVER()
FROM test_all_types()
----
true	127	32767	2147483647	9223372036854775807	170141183460469231731687303715884105727	340282366920938463463374607431768211455	255	65535	4294967295	18446744073709551615	179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368	5881580-07-10	24:00:00	294247-01-10 04:00:54.775806	294247-01-10 04:00:54	294247-01-10 04:00:54.775	2262-04-11 23:47:16.854775806	24:00:00-15:59:59	294247-01-10 04:00:54.775806+00	3.4028235e+38	1.7976931348623157e+308	999.9	99999.9999	999999999999.999999	9999999999999999999999999999.9999999999	ffffffff-ffff-ffff-ffff-ffffffffffff	83 years 3 months 999 days 00:16:39.999999	goo\0se	\x00\x00\x00a	10101	GOOSE	enum_299	enum_69999	[42, 999, NULL, NULL, -42]	[42.0, nan, inf, -inf, NULL, -42.0]	[1970-01-01, infinity, -infinity, NULL, 2022-05-12]	[1970-01-01 00:00:00, infinity, -infinity, NULL, 2022-05-12 16:23:45]	[1970-01-01 00:00:00+00, infinity, -infinity, NULL, 2022-05-12 23:23:45+00]	[🦆🦆🦆🦆🦆🦆, goose, NULL, ]	[[], [42, 999, NULL, NULL, -42], NULL, [], [42, 999, NULL, NULL, -42]]	{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}	{'a': [42, 999, NULL, NULL, -42], 'b': [🦆🦆🦆🦆🦆🦆, goose, NULL, ]}	[{'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, NULL]	{key1=🦆🦆🦆🦆🦆🦆, key2=goose}	5	[4, 5, 6]	[d, e, f]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]	[[d, e, f], [a, NULL, c], [d, e, f]]	[{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, {'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}]	{'a': [4, 5, 6], 'b': [d, e, f]}	[[42, 999, NULL, NULL, -42], [], [42, 999, NULL, NULL, -42]]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]	true	127	32767	2147483647	9223372036854775807	170141183460469231731687303715884105727	340282366920938463463374607431768211455	255	65535	4294967295	18446744073709551615	179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368	5881580-07-10	24:00:00	294247-01-10 04:00:54.775806	294247-01-10 04:00:54	294247-01-10 04:00:54.775	2262-04-11 23:47:16.854775806	24:00:00-15:59:59	294247-01-10 04:00:54.775806+00	3.4028235e+38	1.7976931348623157e+308	999.9	99999.9999	999999999999.999999	9999999999999999999999999999.9999999999	ffffffff-ffff-ffff-ffff-ffffffffffff	83 years 3 months 999 days 00:16:39.999999	goo\0se	\x00\x00\x00a	10101	GOOSE	enum_299	enum_69999	[42, 999, NULL, NULL, -42]	[42.0, nan, inf, -inf, NULL, -42.0]	[1970-01-01, infinity, -infinity, NULL, 2022-05-12]	[1970-01-01 00:00:00, infinity, -infinity, NULL, 2022-05-12 16:23:45]	[1970-01-01 00:00:00+00, infinity, -infinity, NULL, 2022-05-12 23:23:45+00]	[🦆🦆🦆🦆🦆🦆, goose, NULL, ]	[[], [42, 999, NULL, NULL, -42], NULL, [], [42, 999, NULL, NULL, -42]]	{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}	{'a': [42, 999, NULL, NULL, -42], 'b': [🦆🦆🦆🦆🦆🦆, goose, NULL, ]}	[{'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, NULL]	{key1=🦆🦆🦆🦆🦆🦆, key2=goose}	5	[4, 5, 6]	[d, e, f]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]	[[d, e, f], [a, NULL, c], [d, e, f]]	[{'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}, {'a': NULL, 'b': NULL}, {'a': 42, 'b': 🦆🦆🦆🦆🦆🦆}]	{'a': [4, 5, 6], 'b': [d, e, f]}	[[42, 999, NULL, NULL, -42], [], [42, 999, NULL, NULL, -42]]	[[4, 5, 6], [NULL, 2, 3], [4, 5, 6]]
NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL

# Test round trip for all types
statement ok
create table all_types as from test_all_types()

foreach col <all_types_columns>

query TT
EXPLAIN
SELECT lead(lag, -1) over () IS NOT DISTINCT FROM lag(lead, 1) over ()
FROM (
	SELECT lag("${col}", 1) OVER () AS lag, lead("${col}", -1) OVER () AS lead 
	FROM test_all_types()
)
QUALIFY row_number() over ()==2;
----
physical_plan	<REGEX>:.*STREAMING_WINDOW.*

query I
SELECT lead(lag, -1) over () IS NOT DISTINCT FROM lag(lead, 1) over ()
FROM (
	SELECT lag("${col}", 1) OVER () AS lag, lead("${col}", -1) OVER () AS lead 
	FROM test_all_types()
)
QUALIFY row_number() over ()==2;
----
true

query TT
EXPLAIN
SELECT lead(lag, 1) over () IS NOT DISTINCT FROM lag(lead, -1) over ()
FROM (
	SELECT lag("${col}", -1) OVER () AS lag, lead("${col}", 1) OVER () AS lead 
	FROM test_all_types()
)
QUALIFY row_number() over ()==2;
----
physical_plan	<REGEX>:.*STREAMING_WINDOW.*

query I
SELECT lead(lag, 1) over () IS NOT DISTINCT FROM lag(lead, -1) over ()
FROM (
	SELECT lag("${col}", -1) OVER () AS lag, lead("${col}", 1) OVER () AS lead 
	FROM test_all_types()
)
QUALIFY row_number() over ()==2;
----
true

endloop
