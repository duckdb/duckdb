# name: test/sql/copy_database/copy_database_with_index.test
# description: Test the COPY DATABASE statement with indexes
# group: [copy_database]

statement ok
PRAGMA enable_verification;

statement ok
SET threads=1;

statement ok
ATTACH '__TEST_DIR__/old.db' AS old;

statement ok
CREATE TABLE old.items (_id INTEGER);

statement ok
INSERT INTO old.items (_id) VALUES (1), (2), (3);

statement ok
CREATE UNIQUE INDEX idx_id ON old.items(_id);

# query I
# FROM old.items WHERE _id > 2;
# ----
# 3

statement ok
ATTACH '__TEST_DIR__/new.db' AS new;

statement ok
COPY FROM DATABASE "old" TO "new" (SCHEMA);

statement ok
COPY FROM DATABASE "old" TO "new" (DATA);

# statement ok
# COPY FROM DATABASE old TO new;

# query I
# FROM new.items ORDER BY ALL;
# ----
# 1
# 2
# 3
#
# query I
# FROM new.items WHERE _id > 2;
# ----
# 3

statement ok
DETACH new;

statement ok
ATTACH '__TEST_DIR__/new.db' AS new;

statement error
INSERT INTO new.items VALUES (1);
----
constraint

# query I
# FROM new.items ORDER BY ALL;
# ----
# 1
# 2
# 3
#
# query I
# FROM new.items WHERE _id > 2;
# ----
# 3