# name: test/sql/table_function/duckdb_eviction_queues.test
# description: Test duckdb_eviction_queues table function
# group: [table_function]

load __TEST_DIR__/eviction_queues.db

# fudge factor for approximate_size drift
statement ok
CREATE MACRO fudge() AS (5);

# dead_nodes bounded by size and insertions on all queues
statement ok
CREATE MACRO eviction_invariants_ok() AS (
  SELECT COUNT(*) = 0 FROM duckdb_eviction_queues()
  WHERE dead_nodes < 0 OR dead_nodes > approximate_size + fudge() OR dead_nodes > total_insertions
);

# queue size roughly matches insertions (nothing removed yet)
statement ok
CREATE MACRO queue_no_eviction(idx) AS (
  SELECT (abs(approximate_size - total_insertions) <= fudge())::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

# queue has alive blocks in the pool (size minus dead entries)
statement ok
CREATE MACRO queue_has_alive_blocks(idx) AS (
  SELECT (approximate_size - dead_nodes > 0)::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

# queue is (almost) fully evicted: no blocks remain
statement ok
CREATE MACRO queue_fully_evicted(idx) AS (
  SELECT (approximate_size <= fudge())::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

# dead nodes are low (fresh write or just cleaned)
statement ok
CREATE MACRO queue_dead_nodes_low(idx) AS (
  SELECT (dead_nodes <= fudge())::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

# most entries are dead (stale from churn, not yet purged)
statement ok
CREATE MACRO queue_mostly_dead(idx) AS (
  SELECT (dead_nodes > approximate_size / 2)::INT
  FROM duckdb_eviction_queues() WHERE queue_index = idx
);

# snapshot table for delta-based checks
statement ok
CREATE TEMP TABLE snap(queue_index BIGINT, snap_size BIGINT, snap_insertions BIGINT);

# entries were removed from queue since snapshot (delta insertions >> delta size).
# with no memory pressure, this means purge ran.
statement ok
CREATE MACRO queue_entries_removed_since_snapshot(idx) AS (
  SELECT ((c.total_insertions - s.snap_insertions) > (c.approximate_size - s.snap_size) * 2)::INT
  FROM duckdb_eviction_queues() c
  JOIN snap s ON c.queue_index = s.queue_index
  WHERE c.queue_index = idx
);

statement ok
CREATE TABLE t AS SELECT range AS i, range::VARCHAR AS s
FROM range(2000000);

# table produced persistent blocks
query I
SELECT queue_has_alive_blocks(0);
----
1

# nothing evicted yet
query I
SELECT queue_no_eviction(0);
----
1

query I
SELECT eviction_invariants_ok();
----
1

# checkpoint flushes WAL to disk, blocks remain in buffer pool
statement ok
CHECKPOINT;

# blocks still in pool after checkpoint, no eviction on either queue
query I
SELECT queue_has_alive_blocks(0);
----
1

query I
SELECT queue_has_alive_blocks(1);
----
1

query I
SELECT queue_no_eviction(0);
----
1

query I
SELECT queue_no_eviction(1);
----
1

query I
SELECT eviction_invariants_ok();
----
1

# full scan forces all data blocks into the buffer pool
query I
SELECT SUM(length(s)) FROM t;
----
12888890

# scan re-inserted existing blocks with new sequence numbers, old entries are now dead
query I
SELECT queue_mostly_dead(1);
----
1

query I
SELECT queue_no_eviction(0);
----
1

query I
SELECT eviction_invariants_ok();
----
1

# constrain memory to force eviction
statement ok
SET memory_limit='2MB';

# eviction sweep cleaned dead nodes on queue 0
query I
SELECT queue_dead_nodes_low(0);
----
1

query I
SELECT eviction_invariants_ok();
----
1

# heavy cycling: repeated scans at 4MB force eviction on every scan,
# accumulating dead nodes as blocks are evicted and re-loaded
statement ok
SET memory_limit='4MB';

loop i 0 10

query I
SELECT SUM(length(s)) FROM t;
----
12888890

endloop

# dead nodes stay low because eviction sweep cleans them on every scan
query I
SELECT queue_dead_nodes_low(0);
----
1

query I
SELECT eviction_invariants_ok();
----
1

statement ok
SET memory_limit='2GB';

# snapshot before purge loop
statement ok
DELETE FROM snap;

statement ok
INSERT INTO snap SELECT queue_index, approximate_size, total_insertions FROM duckdb_eviction_queues();

loop i 0 3000

query I
SELECT SUM(length(s)) FROM t;
----
12888890

endloop

query I
SELECT queue_entries_removed_since_snapshot(0);
----
1

query I
SELECT eviction_invariants_ok();
----
1
