# name: test/sql/index/art/storage/test_art_buffered_replays_multi_col.test
# description: Test buffered replays with multiple columns, generated column, and unique index on middle column
# group: [storage]

load __TEST_DIR__/test_art_buffered_replays_multi_col.db

statement ok
SET wal_autocheckpoint = '1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
CREATE TABLE tbl(
    col1 INTEGER,
    col2 INTEGER,
    idx_col INTEGER,
    gen_col INTEGER GENERATED ALWAYS AS (col1 + col2) VIRTUAL,
    col5 VARCHAR
);

statement ok
CREATE UNIQUE INDEX idx_tbl_idx_col ON tbl(idx_col);

statement ok
INSERT INTO tbl (col1, col2, idx_col, col5) SELECT r, r * 2, r, 'val' || r::VARCHAR FROM range(0, 1001) t(r);

statement ok
DELETE FROM tbl WHERE idx_col % 2 = 0;

restart

loop i 0 50

query II
EXPLAIN ANALYZE SELECT idx_col FROM tbl WHERE idx_col = ${i} * 2;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT EXISTS (SELECT 1 FROM tbl WHERE idx_col = ${i} * 2);
----
0

endloop

loop i 0 50

query II
EXPLAIN ANALYZE SELECT idx_col FROM tbl WHERE idx_col = ${i} * 2 + 1;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT EXISTS (SELECT 1 FROM tbl WHERE idx_col = ${i} * 2 + 1);
----
1

statement error
INSERT INTO tbl (col1, col2, idx_col, col5) VALUES (${i} * 2 + 1, ${i} * 4 + 2, ${i} * 2 + 1, 'duplicate' || (${i} * 2 + 1)::VARCHAR);
----
<REGEX>:.*Constraint Error: Duplicate key.*violates unique constraint.*

endloop

query II
EXPLAIN ANALYZE SELECT idx_col FROM tbl WHERE idx_col = 0;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT idx_col FROM tbl WHERE idx_col = 0;
----

query II
EXPLAIN ANALYZE SELECT idx_col FROM tbl WHERE idx_col = 10;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT idx_col FROM tbl WHERE idx_col = 10;
----