# name: test/sql/index/art/storage/test_art_buffered_replays_interleaved.test
# description: Test interleaved buffered index replays with multi-chunk batches
# group: [storage]

load __TEST_DIR__/test_interleaved_replays.db

statement ok
SET wal_autocheckpoint = '1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
CREATE TABLE tbl (i INTEGER);

statement ok
CREATE UNIQUE INDEX idx_i ON tbl (i);

loop i 0 9

statement ok
INSERT INTO tbl SELECT r FROM range(${i} * 10000, ${i} * 10000 + 3000) t(r);

statement ok
DELETE FROM tbl WHERE i >= ${i} * 10000 AND i < ${i} * 10000 + 2500;

endloop

restart

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 5000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

statement error
INSERT INTO tbl VALUES (12501);
----
Constraint Error: Duplicate key "i: 12501" violates unique constraint.

query I
SELECT i FROM tbl WHERE i = 12501;
----
12501

query I
SELECT i FROM tbl WHERE i = 1;
----

