# name: test/sql/index/art/storage/test_art_buffered_replays_interval_merging.test
# description: Test interval merging for buffered index replays
# group: [storage]

load __TEST_DIR__/test_interval_merging_replays.db

statement ok
SET wal_autocheckpoint = '1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
CREATE TABLE tbl(i INTEGER);

statement ok
CREATE UNIQUE INDEX idx_tbl_i ON tbl(i);

loop i 0 4

statement ok
INSERT INTO tbl SELECT r FROM range(${i} * 10000, ${i} * 10000 + 2001) t(r);

statement ok
INSERT INTO tbl SELECT r FROM range(${i} * 10000 + 2001, ${i} * 10000 + 4001) t(r);

statement ok
INSERT INTO tbl SELECT r FROM range(${i} * 10000 + 4001, ${i} * 10000 + 5001) t(r);

statement ok
DELETE FROM tbl WHERE i >= ${i} * 10000 AND i < ${i} * 10000 + 2500;

endloop

statement ok
INSERT INTO tbl VALUES (60000);

statement ok
INSERT INTO tbl VALUES (60001);

restart

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 60000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 60000;
----
60000

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 60001;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 60001;
----
60001

loop val 0 4

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = ${val} * 10000 + 1000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = ${val} * 10000 + 1000;
----

endloop

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 3000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 3000;
----
3000

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 13000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 13000;
----
13000

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 23000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 23000;
----
23000

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 4500;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 4500;
----
4500

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 14500;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 14500;
----
14500

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 24500;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 24500;
----
24500

statement error
INSERT INTO tbl VALUES (60000);
----
Constraint Error: Duplicate key "i: 60000" violates unique constraint.

