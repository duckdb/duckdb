# name: test/sql/index/art/storage/test_art_buffered_replays_chunk_edges.test
# description: Interleaved buffered replays that cross chunk boundaries with delete ranges that must remain separate
# group: [storage]

load __TEST_DIR__/test_interleaved_replays_chunk_edges.db

statement ok
SET wal_autocheckpoint = '1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
CREATE TABLE tbl(i INTEGER);

statement ok
CREATE UNIQUE INDEX idx_tbl_i ON tbl(i);

# Range 1: partial first chunk [0, 250]
statement ok
INSERT INTO tbl SELECT r FROM range(0, 251) t(r);

statement ok
DELETE FROM tbl WHERE i BETWEEN 0 AND 250;

# Range 2: crosses the 2048 chunk boundary [251, 2048]
statement ok
INSERT INTO tbl SELECT r FROM range(251, 2049) t(r);

statement ok
DELETE FROM tbl WHERE i BETWEEN 251 AND 2048;

# Range 3: remainder of the second chunk [2049, 4095]
statement ok
INSERT INTO tbl SELECT r FROM range(2049, 4096) t(r);

statement ok
DELETE FROM tbl WHERE i BETWEEN 2049 AND 4095;

statement ok
INSERT INTO tbl VALUES (5000);

statement ok
INSERT INTO tbl VALUES (6000);

statement ok
DELETE FROM tbl WHERE i = 5000;

restart

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 5000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 5000;
----

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 5000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 5000;
----

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 6000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 6000;
----
6000



