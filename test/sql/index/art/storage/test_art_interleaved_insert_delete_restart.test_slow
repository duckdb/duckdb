# name: test/sql/index/art/storage/test_art_interleaved_insert_delete_restart.test_slow
# description: Test interleaved index inserts and delete buffering doesn't cause OOM.
# group: [storage]

# FIXME: When indexes are buffer managed, this should be uncommented, and also the loop iteration can be reduced
# by an order of 10 to hit the 1GB threshold without the allocation fixes.
# right now this test should OOM without the unbound index allocation fixes in place.
# statement ok
# SET memory_limit='1GB'

load __TEST_DIR__/test_art_interleaved_insert_delete_restart.db

statement ok
SET wal_autocheckpoint = '1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
CREATE TABLE tbl (i INTEGER);

statement ok
CREATE UNIQUE INDEX idx_i ON tbl (i);

loop i 0 1000000

statement ok
INSERT INTO tbl VALUES (${i});

statement ok
DELETE FROM tbl WHERE i = ${i};

endloop

restart

query II
EXPLAIN ANALYZE SELECT i FROM tbl WHERE i = 2;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT i FROM tbl WHERE i = 2;
----

