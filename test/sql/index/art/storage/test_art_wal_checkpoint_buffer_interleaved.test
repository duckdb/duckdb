# name: test/sql/index/art/storage/test_art_wal_checkpoint_buffer_interleaved.test
# description: Ensure interleaved buffered operations serialize/deserialize correctly for single-column indexes
# group: [storage]

load __TEST_DIR__/test_art_wal_checkpoint_buffer_interleaved.db

statement ok
SET index_scan_max_count = 1;

statement ok
PRAGMA wal_autocheckpoint='1TB';

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
CREATE TABLE wal_checkpoint_interleaved(b INTEGER);

statement ok
CREATE UNIQUE INDEX wal_checkpoint_interleaved_idx ON wal_checkpoint_interleaved(b);

statement ok
INSERT INTO wal_checkpoint_interleaved SELECT range FROM range(200);

statement ok
DELETE FROM wal_checkpoint_interleaved WHERE b % 2 = 0;

statement ok
INSERT INTO wal_checkpoint_interleaved SELECT range + 200 FROM range(50);

statement ok
DELETE FROM wal_checkpoint_interleaved WHERE b % 5 = 1;

statement ok
INSERT INTO wal_checkpoint_interleaved VALUES (501);

statement ok
DELETE FROM wal_checkpoint_interleaved WHERE b = 501;

query I
SELECT COUNT(*) FROM wal_checkpoint_interleaved;
----
120

query II
EXPLAIN ANALYZE SELECT * FROM wal_checkpoint_interleaved WHERE b = 17;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM wal_checkpoint_interleaved WHERE b = 17;
----
17

query I
SELECT * FROM wal_checkpoint_interleaved WHERE b = 10;
----

restart

statement ok
CHECKPOINT;

restart

query I
SELECT COUNT(*) FROM wal_checkpoint_interleaved;
----
120

query II
EXPLAIN ANALYZE SELECT * FROM wal_checkpoint_interleaved WHERE b = 17;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM wal_checkpoint_interleaved WHERE b = 17;
----
17

query I
SELECT * FROM wal_checkpoint_interleaved WHERE b = 10;
----


