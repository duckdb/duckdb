# name: test/sql/index/art/storage/test_art_detach_no_context.test
# description: Ensure DETACH triggers checkpoint without original context
# group: [storage]

statement ok
SET threads = 1;

statement ok
SET checkpoint_threshold = '10.0 GB';

# The only place we checkpoint without context is during DETACH.
# However, with this pragma in place, we now no longer checkpoint during DETACH.
# Meaning all other checkpoints now have the context.

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
ATTACH '__TEST_DIR__/detach_no_context.db';

statement ok
CREATE TABLE detach_no_context.t (i INT);

statement ok
CREATE UNIQUE INDEX idx_detach_no_context ON detach_no_context.t(i);

statement ok
INSERT INTO detach_no_context.t VALUES (1);

statement ok
DETACH detach_no_context;

# Here we should have buffered appends afterwards.
# Let's also disable our pragma

statement ok
PRAGMA enable_checkpoint_on_shutdown;

statement ok
ATTACH '__TEST_DIR__/detach_no_context.db';

# Checkpoint without context.

statement ok
DETACH detach_no_context;

statement ok
ATTACH '__TEST_DIR__/detach_no_context.db';

statement error
INSERT INTO detach_no_context.t VALUES (1), (2);
----
violates unique constraint

