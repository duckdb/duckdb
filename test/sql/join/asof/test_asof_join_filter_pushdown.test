# name: test/sql/join/asof/test_asof_join_filter_pushdown.test
# description: Test ASOF JOIN filter pushdown correctness
# group: [asof]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE left_table (id INTEGER, ts TIMESTAMP, symbol VARCHAR, price DECIMAL);

statement ok
INSERT INTO left_table VALUES
(1, '2024-01-01 10:00:00', 'A', 150.00),
(2, '2024-01-01 10:05:00', 'A', 151.00),
(3, '2024-01-01 10:10:00', 'B', 380.00);

statement ok
CREATE TABLE right_table (id INTEGER, ts TIMESTAMP, symbol VARCHAR, bid DECIMAL, active BOOLEAN);

statement ok
INSERT INTO right_table VALUES
(1, '2024-01-01 09:59:00', 'A', 149.50, true),
(2, '2024-01-01 10:04:00', 'A', 150.50, false),
(3, '2024-01-01 10:09:00', 'B', 379.00, true);

query IITTIITTI rowsort
SELECT * FROM left_table l
ASOF JOIN right_table r
ON l.symbol = r.symbol AND l.ts >= r.ts AND l.price > 150 AND r.active = true;
----
2	2024-01-01 10:05:00	A	151.000	1	2024-01-01 09:59:00	A	149.500	1
3	2024-01-01 10:10:00	B	380.000	3	2024-01-01 10:09:00	B	379.000	1

query IITTIITTI rowsort
SELECT * FROM left_table l
ASOF JOIN right_table r
ON l.symbol = r.symbol AND l.ts >= r.ts AND r.active = true;
----
1	2024-01-01 10:00:00	A	150.000	1	2024-01-01 09:59:00	A	149.500	1
2	2024-01-01 10:05:00	A	151.000	1	2024-01-01 09:59:00	A	149.500	1
3	2024-01-01 10:10:00	B	380.000	3	2024-01-01 10:09:00	B	379.000	1

query IITTIITTI rowsort
SELECT * FROM left_table l
ASOF LEFT JOIN right_table r
ON l.symbol = r.symbol AND l.ts >= r.ts AND l.price > 150;
----
1	2024-01-01 10:00:00	A	150.000	NULL	NULL	NULL	NULL	NULL
2	2024-01-01 10:05:00	A	151.000	2	2024-01-01 10:04:00	A	150.500	0
3	2024-01-01 10:10:00	B	380.000	3	2024-01-01 10:09:00	B	379.000	1

query IITTIITTI rowsort
SELECT * FROM left_table l
ASOF JOIN right_table r
ON l.symbol = r.symbol AND l.ts >= r.ts AND true;
----
1	2024-01-01 10:00:00	A	150.000	1	2024-01-01 09:59:00	A	149.500	1
2	2024-01-01 10:05:00	A	151.000	2	2024-01-01 10:04:00	A	150.500	0
3	2024-01-01 10:10:00	B	380.000	3	2024-01-01 10:09:00	B	379.000	1

query IITTIITTI rowsort
SELECT * FROM left_table l
ASOF JOIN right_table r
ON l.symbol = r.symbol AND l.ts >= r.ts AND false;
----

query IITTIITTI rowsort
SELECT * FROM left_table l
ASOF JOIN right_table r
ON l.symbol = r.symbol AND l.ts >= r.ts AND l.price + r.bid > 300;
----
2	2024-01-01 10:05:00	A	151.000	2	2024-01-01 10:04:00	A	150.500	0
3	2024-01-01 10:10:00	B	380.000	3	2024-01-01 10:09:00	B	379.000	1

query IITTIITTI rowsort
SELECT * FROM left_table l
ASOF LEFT JOIN right_table r
ON l.symbol = r.symbol AND l.ts >= r.ts AND l.price + r.bid > 300;
----
1	2024-01-01 10:00:00	A	150.000	NULL	NULL	NULL	NULL	NULL
2	2024-01-01 10:05:00	A	151.000	2	2024-01-01 10:04:00	A	150.500	0
3	2024-01-01 10:10:00	B	380.000	3	2024-01-01 10:09:00	B	379.000	1
