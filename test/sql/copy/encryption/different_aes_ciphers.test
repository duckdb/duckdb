# name: test/sql/copy/encryption/different_aes_ciphers.test
# group: [encryption]

statement ok
PRAGMA enable_verification

# We need httpfs to do encrypted writes
require httpfs

statement error
ATTACH '__TEST_DIR__/encrypted.duckdb' AS encrypted (ENCRYPTION_KEY '');
----
Binder Error: Not a valid key. A key cannot be empty

statement error
ATTACH '__TEST_DIR__/encrypted.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER 'random');
----
Binder Error: "random" is not a valid cipher. Try 'GCM' or 'CTR'.

statement error
ATTACH '__TEST_DIR__/encrypted.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER '');
----
Binder Error: "" is not a valid cipher. Try 'GCM' or 'CTR'.

statement error
ATTACH '__TEST_DIR__/encrypted.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER 42);
----
Binder Error: "42" is not a valid cipher. Try 'GCM' or 'CTR'.

foreach cipher GCM CTR

statement ok
ATTACH '__TEST_DIR__/encrypted_${cipher}.duckdb' AS encrypted_${cipher} (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER '${cipher}');

query I
select encrypted from duckdb_databases() where database_name = 'encrypted_${cipher}' and cipher='${cipher}';
----
true

endloop


# we can create a database with a specific cipher (CTR)
statement ok
ATTACH '__TEST_DIR__/encrypted_default_cipher.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER 'CTR');

statement ok
create table encrypted.fuu as select 42;

statement ok
DETACH encrypted

# we can open it again by specifying that same cipher again
statement ok
ATTACH '__TEST_DIR__/encrypted_default_cipher.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER 'CTR');

query I
FROM encrypted.fuu
----
42

statement ok
DETACH encrypted

# opening the database without cipher for CTR is not possible for security reasons
statement error
ATTACH '__TEST_DIR__/encrypted_default_cipher.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf');
----
Catalog Error: Cannot open encrypted database

# but it will fail if we specify the wrong one
statement error
ATTACH '__TEST_DIR__/encrypted_default_cipher.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER 'GCM');
----
with a different cipher (GCM) than the one used to create it (CTR)


# CBC is disabled (for now)
statement error
ATTACH '__TEST_DIR__/CBC.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf', ENCRYPTION_CIPHER 'CBC');
----
CBC encryption is disabled
