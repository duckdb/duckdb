# name: test/sql/copy/encryption/test_different_encryption_versions.test
# group: [encryption]

require skip_reload

require tpch

# We need httpfs to do encrypted writes
require httpfs

statement ok
PRAGMA enable_verification

statement error
ATTACH '__TEST_DIR__/encrypted_invalid.duckdb' AS encrypted_invalid (ENCRYPTION_KEY 'asdf', STORAGE_VERSION 'v1.4.0', debug_encryption_version 'v1');
----
Explicit provided STORAGE_VERSION ("v1.4.0") is not compatible with 'debug_encryption_version = v1' (storage >= v1.5.0)

statement ok
ATTACH '__TEST_DIR__/encrypted_storage.duckdb' AS encrypted_storage_version (ENCRYPTION_KEY 'asdf', STORAGE_VERSION 'v1.4.0');

query I
SELECT tags['storage_version'] FROM duckdb_databases() WHERE database_name='encrypted_storage_version'
----
v1.4.0+

statement ok
ATTACH '__TEST_DIR__/encrypted_v0_0.duckdb' AS encrypted_v0 (ENCRYPTION_KEY 'asdf', debug_encryption_version 'v0');

query I
SELECT tags['storage_version'] FROM duckdb_databases() WHERE database_name='encrypted_v0'
----
v1.5.0+

statement ok
ATTACH '__TEST_DIR__/encrypted_v0_1.duckdb' AS encrypted_v1 (ENCRYPTION_KEY 'asdf', debug_encryption_version 'v1');

query I
SELECT tags['storage_version'] FROM duckdb_databases() WHERE database_name='encrypted_v1'
----
v1.5.0+

statement error
ATTACH '__TEST_DIR__/encrypted_error.duckdb' AS encrypted_error (ENCRYPTION_KEY 'asdf', debug_encryption_version 'v2');
----
Not implemented Error: No encryption version higher then v1 is supported yet in this DuckDB version

statement ok
ATTACH '__TEST_DIR__/unencrypted.duckdb' as unencrypted;

statement ok
USE unencrypted;

statement ok
CALL dbgen(sf=0.01);

statement ok
COPY FROM DATABASE unencrypted to encrypted_storage_version;

statement ok
COPY FROM DATABASE unencrypted to encrypted_v0;

statement ok
COPY FROM DATABASE unencrypted to encrypted_v1;

statement ok
ATTACH '__TEST_DIR__/not_relevant.duckdb' AS other;

statement ok
USE other;

statement ok
DETACH encrypted_storage_version;

statement ok
DETACH unencrypted

statement ok
DETACH encrypted_v0

statement ok
DETACH encrypted_v1

# the setting of debug_encryption_version gets overridden
# if the (de)serialized encryption version differs
statement ok
ATTACH '__TEST_DIR__/encrypted_storage.duckdb' AS encrypted_storage_version (ENCRYPTION_KEY 'asdf', debug_encryption_version 'v1');

statement ok
ATTACH '__TEST_DIR__/encrypted_v0_1.duckdb' AS encrypted_v1 (ENCRYPTION_KEY 'asdf', debug_encryption_version 'v0');

statement ok
ATTACH '__TEST_DIR__/encrypted_v0_0.duckdb' AS encrypted_v0 (ENCRYPTION_KEY 'asdf', debug_encryption_version 'v0');


query I
SELECT l_suppkey FROM encrypted_v0.lineitem limit 10;
----
93
75
38
48
23
10
33
19
70
60

query I
SELECT l_suppkey FROM encrypted_v1.lineitem limit 10;
----
93
75
38
48
23
10
33
19
70
60
