# name: test/sql/copy/parquet/parquet_hive_null.test
# description: Test NULL partitioning values
# group: [parquet]

require parquet

statement ok
create table test as select i%5 as a, i%2 as b from range(0,10) tbl(i);

statement ok
copy (FROM test UNION ALL select 'NULL' as a, 'NULL' as b) to '__TEST_DIR__/null-parquet' (PARTITION_BY (a,b), FORMAT 'parquet', WRITE_PARTITION_COLUMNS);

query II
select * 
from parquet_scan('__TEST_DIR__/null-parquet/**/*.parquet', hive_partitioning=1, hive_types={'a': INT})
ORDER BY ALL
----
0	0
0	1
1	0
1	1
2	0
2	1
3	0
3	1
4	0
4	1
NULL	NULL

statement ok
create table test2 as select i%5 as a, i%2 as b, i as c from range(0,10) tbl(i);

statement ok
copy (FROM test2 UNION ALL select 'NULL' as a, 'NULL' as b, 'NULL' as c) to '__TEST_DIR__/null-parquet' (PARTITION_BY (a,b), FORMAT 'parquet', OVERWRITE);

query III
select * 
from parquet_scan('__TEST_DIR__/null-parquet/**/*.parquet', hive_partitioning=1, hive_types={'a': INT})
ORDER BY ALL
----
0	0	0
1	1	1
2	2	0
3	3	1
4	4	0
5	0	1
6	1	0
7	2	1
8	3	0
9	4	1
NULL	NULL	NULL

# Test __HIVE_DEFAULT_PARTITION__ is treated as NULL when reading
# First create the nested directory structure using a dummy partitioned write
statement ok
copy (select 0 as c, NULL::INT as a, NULL::INT as b) to '__TEST_DIR__/hive-default-partition-test' (PARTITION_BY (a, b), FORMAT 'parquet', OVERWRITE);

# Now overwrite the file in that directory to test reading __HIVE_DEFAULT_PARTITION__
statement ok
copy (select 1 as c) to '__TEST_DIR__/hive-default-partition-test/a=__HIVE_DEFAULT_PARTITION__/b=__HIVE_DEFAULT_PARTITION__/data.parquet' (FORMAT 'parquet');

query III
select *
from parquet_scan('__TEST_DIR__/hive-default-partition-test/a=__HIVE_DEFAULT_PARTITION__/b=__HIVE_DEFAULT_PARTITION__/data.parquet', hive_partitioning=1, hive_types={'a': INT, 'b': INT})
ORDER BY ALL
----
1	NULL	NULL

# Test that NULL values are written as __HIVE_DEFAULT_PARTITION__
statement ok
create table test_null_write as select 1 as c, NULL::INT as a, NULL::INT as b;

statement ok
copy test_null_write to '__TEST_DIR__/hive-null-write-test' (PARTITION_BY (a,b), FORMAT 'parquet');

# Verify we can read the data back (proves __HIVE_DEFAULT_PARTITION__ is used and read correctly)
query III
select *
from parquet_scan('__TEST_DIR__/hive-null-write-test/**/*.parquet', hive_partitioning=1, hive_types={'a': INT, 'b': INT})
ORDER BY ALL
----
1	NULL	NULL

# Verify the directory structure uses __HIVE_DEFAULT_PARTITION__
query I
select count(*) from glob('__TEST_DIR__/hive-null-write-test/a=__HIVE_DEFAULT_PARTITION__/b=__HIVE_DEFAULT_PARTITION__/*.parquet');
----
1
