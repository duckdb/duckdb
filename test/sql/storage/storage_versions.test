# name: test/sql/storage/storage_versions.test
# description: Test attach storage various versions
# group: [storage]

# Alternative verify outputs latest storage version for the default storage versions
require no_alternative_verify

# These files were created with vector-size 2048
require vector_size 2048

# File created via "ATTACH 'empty64.db' (STORAGE_VERSION 'v1.1.0')"
statement ok
ATTACH '{DATA_DIR}/storage/empty64.db' (READ_ONLY);
#
# # File created via "ATTACH 'empty65.db' (STORAGE_VERSION 'v1.2.0')"
statement ok
ATTACH '{DATA_DIR}/storage/empty65.db' (READ_ONLY);

# File created via "ATTACH 'empty66.db' (STORAGE_VERSION 'v1.3.0')"
statement ok
ATTACH '{DATA_DIR}/storage/empty66.db' (READ_ONLY);

# File created via "ATTACH 'empty67.db' (STORAGE_VERSION 'v1.4.0')"
statement ok
ATTACH '{DATA_DIR}/storage/empty67.db' (READ_ONLY);

# for duckdb version v1.4.3
# Files created via `duckdb empty67_init.db -c "CHECKPOINT;"
statement ok
ATTACH '{DATA_DIR}/storage/empty67_init.db' (READ_ONLY);

query I
SELECT tags FROM duckdb_databases() WHERE database_name LIKE 'empty67_init%' ORDER BY database_name;
----
{storage_version=v1.0.0+}

query I
SELECT tags FROM duckdb_databases() WHERE database_name LIKE 'empty%' ORDER BY database_name;
----
{storage_version=v1.0.0+}
{storage_version=v1.2.0+}
{storage_version=v1.3.0+}
{storage_version=v1.4.0+}
{storage_version=v1.0.0+}

# We create a new database in most recent duckdb version (v1.4.3)
statement ok
ATTACH '{DATA_DIR}/storage/recent_storage.db' as db;

statement ok
USE db;

# the default storage version is lower then the most recent storage version
query I
SELECT tags FROM duckdb_databases() WHERE database_name='db';
----
{storage_version=v1.0.0+}

statement ok
ATTACH 'random.db' as random;

statement ok
USE random;

statement ok
DETACH db;

# We bump the storage version now explicitly
statement ok
ATTACH '{DATA_DIR}/storage/recent_storage.db' as db (STORAGE_VERSION 'v1.4.0');

statement ok
USE db;

query I
SELECT tags FROM duckdb_databases() WHERE database_name='db';
----
{storage_version=v1.4.0+}
