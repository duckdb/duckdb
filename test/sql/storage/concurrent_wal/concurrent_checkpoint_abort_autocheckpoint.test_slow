# name: test/sql/storage/concurrent_wal/concurrent_checkpoint_abort_autocheckpoint.test_slow
# description: Test recovery when doing concurrent appends with a failing auto-checkpoint
# group: [concurrent_wal]

foreach skip_wal_threshold  0 9999999999

statement ok
SET auto_checkpoint_skip_wal_threshold=${skip_wal_threshold}

statement ok
ATTACH '__TEST_DIR__/concurrent_abort_${skip_wal_threshold}.db' AS main_db

statement ok
SET checkpoint_threshold='50KB'

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
CREATE OR REPLACE TABLE main_db.integers(i INTEGER PRIMARY KEY)

statement ok
SET debug_checkpoint_abort='before_wal_finish'

statement ok
SET debug_checkpoint_sleep_ms=100

concurrentloop threadid 0 20

loop x 0 100

# we write to two databases - the main database (that is being checkpointed) and a back-up database "concurrent_other_db"
# we write to the database "concurrent_other_db" after a commit to the main database has succeeded
# so anything that ends up there has to also be in the main database
# otherwise we have lost data
onlyif threadid=0
statement maybe
DELETE FROM main_db.integers
----

onlyif threadid>0
statement maybe
INSERT INTO main_db.integers SELECT * FROM range(${x} * 200, (${x} + 1) * 200);
----

endloop

endloop

restart

statement ok
ATTACH '__TEST_DIR__/concurrent_abort_${skip_wal_threshold}.db' AS main_db (READ_ONLY)

statement ok
FROM main_db.integers

restart

endloop
