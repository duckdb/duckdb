# name: test/sql/storage/types/variant/variant_stats_merging.test
# group: [variant]

load __TEST_DIR__/variant_stats_merging.db

# Always shred
statement ok
SET variant_minimum_shredding_size = 0;

# -------------------------- Shred 'tbl' on VARCHAR[] --------------------------

statement ok
SET force_variant_shredding = 'VARCHAR[]';

statement ok
create table tbl(col VARIANT);

statement ok
insert into tbl select NULL from range(122880)

statement ok
checkpoint

restart

query I
select stats(col) from tbl limit 1;
----
<REGEX>:.*typed_value_type: VARCHAR\[\].*

# -------------------------- Shred 'tbl' on INTEGER[] --------------------------

statement ok
SET force_variant_shredding = 'INTEGER[]';

statement ok
insert into tbl select NULL from range(122880)

statement ok
checkpoint

restart

# Mixing VARCHAR[] + INTEGER[] results in unshredded
query I
select stats(col) from tbl limit 1;
----
<REGEX>:is_shredded: false.*

# -------------------------- Shred 'tbl2' on OBJECT(a INTEGER, b VARCHAR, c BOOLEAN) --------------------------

statement ok
create table tbl2 (col VARIANT)

statement ok
SET force_variant_shredding = 'STRUCT(a INTEGER, b VARCHAR, c BOOLEAN)';

statement ok
insert into tbl2 select NULL from range(122880)

statement ok
checkpoint

restart

query I
select stats(col) from tbl2 limit 1;
----
<REGEX>:.*typed_value_type: STRUCT\(a INTEGER, b VARCHAR, c BOOLEAN\).*

# -------------------------- Shred 'tbl2' on OBJECT(b VARCHAR, a INTEGER, c BOOLEAN) --------------------------

statement ok
SET force_variant_shredding = 'STRUCT(b VARCHAR, a INTEGER, c BOOLEAN)';

statement ok
insert into tbl2 select NULL from range(122880)

statement ok
checkpoint

restart

# Order of fields shouldn't matter
query I
select stats(col) from tbl2 limit 1;
----
<REGEX>:.*typed_value_type: STRUCT\(a INTEGER, b VARCHAR, c BOOLEAN\).*

# -------------------------- Shred 'tbl2' on OBJECT(b VARCHAR, a INTEGER, c INTEGER) --------------------------

statement ok
SET force_variant_shredding = 'STRUCT(b VARCHAR, a INTEGER, c INTEGER)';

statement ok
insert into tbl2 select NULL from range(122880)

statement ok
checkpoint

restart

# We lose field 'c' because its type is different
query I
select stats(col) from tbl2 limit 1;
----
<REGEX>:.*typed_value_type: STRUCT\(a INTEGER, b VARCHAR\).*

# -------------------------- Shred 'tbl2' on OBJECT(b VARCHAR, c BOOLEAN) --------------------------

statement ok
SET force_variant_shredding = 'STRUCT(b VARCHAR, c BOOLEAN)';

statement ok
insert into tbl2 select NULL from range(122880)

statement ok
checkpoint

restart

query I
select stats(col) from tbl2 limit 1;
----
<REGEX>:.*typed_value_type: STRUCT\(b VARCHAR\).*
