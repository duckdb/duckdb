# name: test/sql/storage/memory/in_memory_mvcc_garbage_collection.test
# group: [memory]

require skip_reload

statement ok
attach ':memory:' as db2 (compress);

statement ok
use db2;

statement ok
pragma force_compression='zstd';

statement ok
pragma memory_limit='2MB';

statement ok
CREATE TABLE tbl AS SELECT range::VARCHAR || 'this is a long string this is a long string this is a long string ' as s FROM range(10000);

# --- Start Reader (con1) ---
statement ok con1
use db2;

statement ok con1
BEGIN TRANSACTION;

query I con1
SELECT count(*) FROM tbl;
----
10000

statement ok
UPDATE tbl SET s = 'updated';

statement ok
FORCE CHECKPOINT;

# --- Verify Reader (con1) ---
query I con1
SELECT count(*) FROM tbl WHERE s != 'updated';
----
10000

statement ok con1
ROLLBACK;