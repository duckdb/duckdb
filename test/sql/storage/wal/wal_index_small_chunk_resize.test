# name: test/sql/storage/wal/wal_index_small_chunk_resize.test
# description: Test WAL replay with small_chunk powers of 2 resizing and spill to ColumnDataCollection
# group: [wal]

load __TEST_DIR__/index_small_chunk_resize_test.db

statement ok
SET index_scan_percentage = 1.0;

statement ok
SET index_scan_max_count = 1;

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
PRAGMA wal_autocheckpoint='1TB';

statement ok
CREATE TABLE tbl(a INTEGER);

statement ok
CREATE INDEX idx_a ON tbl(a);

statement ok
INSERT INTO tbl VALUES (1);

statement ok
INSERT INTO tbl VALUES (2);

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2;
----
2

statement ok
INSERT INTO tbl VALUES (3);

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 3;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 3;
----
3

statement ok
INSERT INTO tbl SELECT * FROM range(4, 129);

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 64;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 64;
----
64

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 128;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 128;
----
128

statement ok
INSERT INTO tbl SELECT * FROM range(129, 513);

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 256;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 256;
----
256

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 512;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 512;
----
512

statement ok
INSERT INTO tbl SELECT * FROM range(513, 2049);

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 1024;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 1024;
----
1024

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2048;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2048;
----
2048

statement ok
INSERT INTO tbl VALUES (2049);

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2049;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2049;
----
2049

statement ok
INSERT INTO tbl VALUES (2050);

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2050;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2050;
----
2050

restart

statement ok
SET index_scan_percentage = 1.0;

statement ok
SET index_scan_max_count = 1;

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 1;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 1;
----
1

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2;
----
2

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 3;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 3;
----
3

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 64;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 64;
----
64

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 128;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 128;
----
128

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 256;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 256;
----
256

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 512;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 512;
----
512

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 1024;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 1024;
----
1024

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2048;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2048;
----
2048

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2049;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2049;
----
2049

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 2050;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 2050;
----
2050

