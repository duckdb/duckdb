# name: test/sql/storage/wal/wal_autocheckpoint_transactions.test
# description: Test automatic checkpoint based on committed transaction count
# group: [wal]

load __TEST_DIR__/wal_autocheckpoint_transactions.db

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
PRAGMA wal_autocheckpoint='1TB';

statement ok
CREATE TABLE tbl(x INTEGER);

statement ok
CHECKPOINT;

query I
SELECT wal_size FROM pragma_database_size();
----
0 bytes

# Set threshold to 5 - checkpoint every 5 transactions (5th triggers checkpoint)
statement ok
SET wal_autocheckpoint_transactions=5;

# Do 4 transactions (count goes 0→1→2→3→4, no checkpoint yet)
statement ok
INSERT INTO tbl VALUES (1);

statement ok
INSERT INTO tbl VALUES (1);

statement ok
INSERT INTO tbl VALUES (1);

statement ok
INSERT INTO tbl VALUES (1);

# WAL should be non-zero (4 entries, not yet at limit)
query I
SELECT wal_size != '0 bytes' FROM pragma_database_size();
----
true

# 5th transaction triggers checkpoint, WAL should be 0 after
statement ok
INSERT INTO tbl VALUES (1);

query I
SELECT wal_size FROM pragma_database_size();
----
0 bytes

query I
SELECT COUNT(*) FROM tbl;
----
5

# Now test with a higher threshold (1000)
statement ok
SET wal_autocheckpoint_transactions=1000;

# Do 999 transactions using a loop (not yet at limit)
loop i 0 999

statement ok
INSERT INTO tbl VALUES (1);

endloop

# WAL should be non-zero (999 entries, not yet at limit)
query I
SELECT wal_size != '0 bytes' FROM pragma_database_size();
----
true

# 1000th transaction triggers checkpoint, WAL should be 0 after
statement ok
INSERT INTO tbl VALUES (1);

query I
SELECT wal_size FROM pragma_database_size();
----
0 bytes

query I
SELECT COUNT(*) FROM tbl;
----
1005

restart

query I
SELECT COUNT(*) FROM tbl;
----
1005
