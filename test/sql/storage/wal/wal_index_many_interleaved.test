# name: test/sql/storage/wal/wal_index_many_interleaved.test
# description: Test WAL replay with many interleaved single-row insert/delete operations on indexed column
# group: [wal]

load __TEST_DIR__/wal_index_many_interleaved.test.db

statement ok
SET index_scan_percentage = 1.0;

statement ok
SET index_scan_max_count = 1;

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET checkpoint_threshold='1TB'

statement ok
CREATE TABLE tbl(a INTEGER);

statement ok
CREATE INDEX idx_a ON tbl(a);

loop i 0 10000000

statement ok
INSERT INTO tbl VALUES (${i});

statement ok
DELETE FROM tbl WHERE a = ${i};

endloop

statement ok
INSERT INTO tbl VALUES (10000000)

restart

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET checkpoint_threshold='1TB'

statement ok
SET index_scan_percentage = 1.0;

statement ok
SET index_scan_max_count = 1;

query I
SELECT COUNT(*) FROM tbl;
----
1

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 10000000;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 10000000;
----
100000000

query I
SELECT * FROM tbl WHERE a = 50000;
----

