# name: test/sql/storage/wal/wal_autocheckpoint_entries.test
# description: Test automatic checkpoint when WAL entry count reaches or exceeds threshold
# group: [wal]

load __TEST_DIR__/wal_autocheckpoint_entries.db

statement ok
PRAGMA disable_checkpoint_on_shutdown;

statement ok
PRAGMA wal_autocheckpoint='1TB';

statement ok
CREATE TABLE tbl(x INTEGER);

statement ok
CREATE TABLE delete_tbl(x INTEGER);

statement ok
INSERT INTO delete_tbl SELECT * FROM range(10000);

statement ok
CHECKPOINT;

query I
SELECT wal_size FROM pragma_database_size();
----
0 bytes

statement ok
SET wal_autocheckpoint_entries=100;

loop i 0 20

statement ok
BEGIN TRANSACTION;

statement ok
INSERT INTO tbl VALUES (${i});

statement ok
DELETE FROM delete_tbl WHERE x = ${i};

statement ok
COMMIT;

query I
SELECT wal_size != '0 bytes' FROM pragma_database_size();
----
true

endloop

# triggers auto checkpoint based on entries threshold.
statement ok
INSERT INTO tbl VALUES (42);

query I
SELECT wal_size FROM pragma_database_size();
----
0 bytes




