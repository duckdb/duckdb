# name: test/sql/storage/wal/wal_size_unaligned_appends.test_slow
# description: Verify that unaligned insertions end up in the WAL
# group: [wal]

load __TEST_DIR__/wal_size_unaligned_appends.db

statement ok
CREATE TABLE IF NOT EXISTS tbl1 AS SELECT 'item_' || range AS a FROM RANGE(1226752)

statement ok
CREATE TABLE IF NOT EXISTS tbl2 AS SELECT 'non_item_' || range AS b FROM RANGE(3)

statement ok
CHECKPOINT

restart

statement ok
SET threads=10

statement ok
SET debug_skip_checkpoint_on_commit=true

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
CREATE TABLE long_wal AS SELECT a FROM tbl1 WHERE a not in (select b from tbl2)

# wal should be small (but exist)
query I
SELECT CASE WHEN size > 500 AND size < 30_000 THEN NULL ELSE size END FROM read_blob('__TEST_DIR__/wal_size_unaligned_appends.db.wal')
----
NULL

query I
SELECT COUNT(*) FROM long_wal
----
1226752

query I
FROM tbl1 EXCEPT ALL FROM long_wal
----

restart

query I
FROM tbl1 EXCEPT ALL FROM long_wal
----

query I
SELECT COUNT(*) FROM long_wal
----
1226752
