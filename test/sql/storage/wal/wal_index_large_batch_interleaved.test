# name: test/sql/storage/wal/wal_index_large_batch_interleaved.test
# description: Test WAL replay with large interleaved insert/delete batches (2.5x STANDARD_VECTOR_SIZE) on indexed column
# group: [wal]

load __TEST_DIR__/wal_index_large_batch_interleaved.test.db

statement ok
SET index_scan_percentage = 1.0;

statement ok
SET index_scan_max_count = 1;

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET checkpoint_threshold='1TB'

statement ok
CREATE TABLE tbl(a INTEGER);

statement ok
CREATE INDEX idx_a ON tbl(a);

loop i 0 3

# [20000, 25120)
statement ok
INSERT INTO tbl SELECT r FROM range(${i}*10000, ${i}*10000 + 5120) t(r);

# [20000, 25000]
statement ok
DELETE FROM tbl WHERE a >= ${i}*10000 AND a <= ${i}*10000 + 5000;

endloop

restart

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET checkpoint_threshold='1TB'

statement ok
SET index_scan_percentage = 1.0;

statement ok
SET index_scan_max_count = 1;

query II
EXPLAIN ANALYZE SELECT * FROM tbl WHERE a = 25010;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT * FROM tbl WHERE a = 25010;
----
25010

# query I
# SELECT * FROM tbl WHERE a = 30005;
# ----
# 30005
#
# query I
# SELECT * FROM tbl WHERE a = 1000;
# ----

