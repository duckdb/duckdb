# name: test/sql/storage/wal/wal_index_delete.test
# description: Test index delete replays.
# group: [wal]

load __TEST_DIR__/index_delete_test.db

statement ok
SET index_scan_max_count = 1;

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
PRAGMA wal_autocheckpoint='1TB';

statement ok
CREATE TABLE tbl(a INTEGER, b VARCHAR, c DOUBLE, d TIMESTAMP);

statement ok
CREATE INDEX idx_ab ON tbl(a, b);

statement ok
CREATE INDEX idx_a ON tbl(a);

statement ok
INSERT INTO tbl SELECT range, 'value_' || range, range * 1.5, '2023-01-01 10:00:00'::TIMESTAMP + INTERVAL (range) DAY FROM range(10);

statement ok
DELETE FROM tbl WHERE a % 5 = 0;

query II
EXPLAIN ANALYZE SELECT a, b, c, d FROM tbl WHERE (a) = 1;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

restart

query II
EXPLAIN ANALYZE SELECT a, b, c, d FROM tbl WHERE (a) = 1;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query IIII
SELECT a, b, c, d FROM tbl WHERE (a) = 1;
----
1	value_1	1.5	2023-01-02 10:00:00

query II
EXPLAIN ANALYZE SELECT a, b, c, d FROM tbl WHERE (a) = 5;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query IIII
SELECT a, b, c, d FROM tbl WHERE (a) = 5;
----

statement ok
INSERT INTO tbl VALUES (5, 'value_5', 7.5, '2023-01-06 10:00:00');

query IIII
SELECT a, b, c, d FROM tbl WHERE (a) = 5;
----
5	value_5	7.5	2023-01-06 10:00:00

query II
EXPLAIN ANALYZE SELECT a, b, c, d FROM tbl WHERE (a) = 2;
----
analyzed_plan	<REGEX>:.*Type: Index Scan.*

query I
SELECT COUNT(*) FROM tbl where (a) = 2;
----
1