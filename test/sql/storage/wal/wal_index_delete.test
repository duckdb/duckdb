# name: test/sql/storage/wal/wal_index_delete.test
# description: Test index delete replays.
# group: [wal]

# load the DB from disk
load __TEST_DIR__/index_delete_test.db

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
PRAGMA wal_autocheckpoint='1TB';

statement ok
CREATE TABLE tbl(a BIGINT, b VARCHAR, c DOUBLE, d TIMESTAMP);

statement ok
CREATE INDEX idx_ab ON tbl(a, b);

statement ok
CREATE INDEX idx_bd ON tbl(b, d)

statement ok
INSERT INTO tbl VALUES (1, 'foo', 10.5, '2023-01-01 10:00:00'), (2, 'bar', 20.5, '2023-02-01 11:00:00'), (3, 'baz', 30.5, '2023-03-01 12:00:00');

query IIII
SELECT a,b,c,d FROM tbl where (a,b) = (1, 'foo')
----
1	foo	10.5	2023-01-01 10:00:00

query IIII
SELECT a, b, c, d FROM tbl ORDER BY a;
----
1	foo	10.5	2023-01-01 10:00:00
2	bar	20.5	2023-02-01 11:00:00
3	baz	30.5 	2023-03-01 12:00:00

query I
SELECT COUNT(*) FROM duckdb_indexes() WHERE table_name = 'tbl';
----
2

statement ok
DELETE FROM tbl WHERE (a, b) = (2, 'bar');

restart

statement ok
INSERT INTO tbl VALUES (4, 'deedadum', 42.0, '3030-10-28 10:00:00')

query IIII
SELECT a, b, c, d FROM tbl where (a, b) = (2, 'bar')
----

query IIII
SELECT a, b, c, d FROM tbl ORDER BY a;
----
1	foo	10.5	2023-01-01 10:00:00
3	baz	30.5 	2023-03-01 12:00:00
4	deedadum	42.0 	3030-10-28 10:00:00

# Verify row count after delete
query I
SELECT COUNT(*) FROM tbl;
----
3