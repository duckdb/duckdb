# name: test/sql/storage/checkpoint/concurrent_load_delete.test_slow
# description: Test concurrent delete load workflow
# group: [checkpoint]

load __TEST_DIR__/concurrent_delete_load.db

statement ok
create or replace table z(id integer);

statement ok
insert into z from range(10_000_000);

statement ok
create or replace table random_values(id int, mod ubigint);

statement ok
insert into random_values select id, (random() * 3)::UBIGINT from range(100) t(id);

loop i 0 100

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET checkpoint_threshold='1TB'

concurrentloop c 0 7

onlyif c=0
statement ok
FORCE CHECKPOINT

onlyif c>0&&c<=5
statement ok
SELECT SUM(id) FROM z

onlyif c=5
statement ok
DELETE FROM z WHERE id%(select mod from random_values where id=${i})=0

onlyif c=6
statement ok
INSERT INTO z FROM range(1000, 100000 + ${c} * 100000)

endloop

restart

endloop

statement ok
CHECKPOINT

restart

statement ok
SELECT SUM(id) FROM z
