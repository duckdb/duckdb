# name: test/sql/storage/checkpoint/keep_small_row_groups.test_slow
# description: Test keeping small row groups
# group: [checkpoint]

load __TEST_DIR__/keep_small_row_groups.db

foreach type noindex index

onlyif type=noindex
statement ok
create or replace table z(id integer, a varchar, b varchar, c varchar);

onlyif type=index
statement ok
create or replace table z(id integer primary key, a varchar, b varchar, c varchar);

statement ok
insert into z select i, sha256(i::varchar) as a, sha256((i**2)::varchar) as b, sha256((i**3)::varchar) as c from range(100000) r(i);

statement ok
CHECKPOINT;

# we insert 100K rows, as part of small 100 row inserts, and checkpoint for each iteration
loop i 0 100

statement ok
insert into z select 100000 + 100 * ${i} + i, 'a','b','c' from range(100) t(i);

statement ok
CHECKPOINT;

endloop

query I
SELECT COUNT(DISTINCT row_group_id) < 5 FROM pragma_storage_info('z')
----
true

endloop
