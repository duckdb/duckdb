# name: test/sql/sample/table_samples/table_sample_converts_to_block_sample.test
# description: Test sampling of larger relations
# group: [table_samples]


# required when testing table samples. See basic_sample_test.test
require vector_size 2048

# Sample fills to FIXED_SAMPLE_SIZE=2048 immediately, then uses reservoir replacement
# for subsequent inserts.

load __TEST_DIR__/test_sample_converts_after_load.db

statement ok
create table materialized_range as select 1 a from range(102400);

# sample fills to 2048 immediately
query I
select count(*) from duckdb_table_sample('materialized_range');
----
2048

restart

statement ok
insert into materialized_range select 2 a from range(102400);

# still 2048 total
query I
select count(*) from duckdb_table_sample('materialized_range');
----
2048

# both values should be represented
query T
select count(distinct a) = 2 from duckdb_table_sample('materialized_range');
----
true

# insert another
statement ok
insert into materialized_range select 3 a from range(102400);

# sample remains at 2048 values
query I
select count(*) from duckdb_table_sample('materialized_range');
----
2048

# 2048 / 3 = 682. so each value should have at least >400
query II
select a, count(*) > 400 from duckdb_table_sample('materialized_range') group by all order by a;
----
1	true
2	true
3	true
