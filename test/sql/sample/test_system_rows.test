# name: test/sql/sample/test_system_rows.test
# description: Test system sampling with row counts
# group: [sample]

statement ok
PRAGMA enable_verification;

# Create test table with 10000 rows
statement ok
CREATE TABLE test_table AS SELECT i FROM range(10000) tbl(i);

# Basic system sampling with row count
query I
SELECT COUNT(*) FROM test_table USING SAMPLE 100 ROWS (system);
----
100

# System sampling with larger row count
query I
SELECT COUNT(*) FROM test_table USING SAMPLE 500 ROWS (system);
----
500

# Verify sampling actually happens at the scan level
query II
EXPLAIN SELECT * FROM test_table USING SAMPLE 100 ROWS (system);
----
physical_plan	<REGEX>:.*SEQ_SCAN.*System: 100 rows.*

# Verify with repeatable seed
query II
EXPLAIN SELECT * FROM test_table USING SAMPLE 500 ROWS (system, 42);
----
physical_plan	<REGEX>:.*SEQ_SCAN.*System: 500 rows.*

# System sampling should not exceed table size
query I
SELECT COUNT(*) FROM test_table USING SAMPLE 15000 ROWS (system);
----
10000

# System sampling with repeatable seed - should give consistent results
loop i 0 5

query I
SELECT COUNT(*) FROM test_table USING SAMPLE 250 ROWS (system, 42);
----
250

endloop

# System sampling with different seeds should potentially give different results
# (but same count)
query I
SELECT COUNT(*) FROM test_table USING SAMPLE 200 ROWS (system, 100);
----
200

query I
SELECT COUNT(*) FROM test_table USING SAMPLE 200 ROWS (system, 999);
----
200

# Test with small table
statement ok
CREATE TABLE small_table AS SELECT i FROM range(10) tbl(i);

query I
SELECT COUNT(*) FROM small_table USING SAMPLE 5 ROWS (system);
----
5

# Request more rows than available
query I
SELECT COUNT(*) FROM small_table USING SAMPLE 20 ROWS (system);
----
10

# Disable verification because when sampling is pushed down before the filter,
# system sampling selects ~100 rows from the entire table first, then applies
# the WHERE clause. Since only half the table matches (i < 5000), we expect
# roughly 50 rows in the result, not 100. This is correct behavior for system
# sampling with filters, but verification would incorrectly flag the mismatch
# between requested (100) and actual (63) row count.
statement ok
PRAGMA disable_verification;

# System sampling with filtering, undershoots due to the filter
query I
SELECT COUNT(*) FROM test_table WHERE i < 5000 USING SAMPLE 100 ROWS (system);
----
63

# System sampling with filtering and pushdown, undershoots due to the filter
query I
SELECT COUNT(*) FROM (SELECT * FROM test_table WHERE i % 2 = 0) tbl(i) USING SAMPLE 200 ROWS (system);
----
103

statement ok
PRAGMA enable_verification;

# System sampling with joins (no pushdown)
query I
SELECT COUNT(*) FROM (
    SELECT a.i FROM test_table a, test_table b WHERE a.i = b.i
) USING SAMPLE 50 ROWS (system);
----
50
