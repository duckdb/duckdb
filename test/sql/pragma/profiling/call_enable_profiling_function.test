# name: test/sql/pragma/profiling/call_enable_profiling_function.test
# description: Test logging
# group: [profiling]

statement ok
PRAGMA profiling_output = '__TEST_DIR__/test.txt'

#############################################################################################################################################
#																																			#
#            disable_profiling()																											#
#																																			#
#############################################################################################################################################

statement ok
CALL disable_profiling();

query I
SELECT current_setting('enable_profiling');
----
NULL

#############################################################################################################################################
#																																			#
#            enable_profiling()	without args																								#
#																																			#
#############################################################################################################################################

statement ok
CALL enable_profiling();

query I
SELECT current_setting('enable_profiling');
----
query_tree

#############################################################################################################################################
#																																			#
#            test setting format																											#
#																																			#
#############################################################################################################################################

statement ok
CALL enable_profiling(format='json')

query I
SELECT current_setting('enable_profiling');
----
json

statement error
CALL enable_profiling(format='i dont exist hehe')
----
Parser Error: Unrecognized print format

#############################################################################################################################################
#																																			#
#            test setting coverage																											#
#																																			#
#############################################################################################################################################

query I
SELECT current_setting('profiling_coverage');
----
SELECT

statement ok
CALL enable_profiling(coverage='all')

query I
SELECT current_setting('profiling_coverage');
----
ALL

statement error
CALL enable_profiling(coverage='i dont exist hehe')
----
Not implemented Error

# Set profiling format and save location to json file
statement ok
CALL enable_profiling(format='json', save_location='__TEST_DIR__/test.json')

query I
SELECT current_setting('enable_profiling');
----
json

query I
SELECT current_setting('profiling_output');
----
__TEST_DIR__/test.json

# format and save location file type don't match
statement error
CALL enable_profiling(format='query_tree', save_location='__TEST_DIR__/test.json')
----
Invalid Input Error: EnableProfiling: the save_location must be a .txt file or match the specified format.

#

# Invalid parameter
statement error
CALL enable_profiling(this_does_not_exist = 'hello');
----
Invalid named parameter "this_does_not_exist" for function enable_profiling

statement error
CALL enable_profiling(format);
----
No function matches the given name and argument types 'enable_profiling(VARCHAR)'.

statement error
CALL enable_profiling(metrics = "hello");
----
Invalid Input Error: EnableProfiling: metrics must be a list of strings or a JSON string

# Set metrics from JSON
statement ok
CALL enable_profiling(metrics = {"OPERATOR_CARDINALITY": "true", "OPERATOR_ROWS_SCANNED": "true", "CUMULATIVE_CARDINALITY": "true", "CUMULATIVE_ROWS_SCANNED": "true"})

query I
SELECT current_setting('custom_profiling_settings');
----
{"OPERATOR_CARDINALITY": "true", "CUMULATIVE_CARDINALITY": "true", "OPERATOR_ROWS_SCANNED": "true", "CUMULATIVE_ROWS_SCANNED": "true"}

# Set metrics from STRUCT
statement ok
CALL enable_profiling(metrics = {'QUERY_NAME': true, 'EXTRA_INFO': true, 'OPERATOR_ROWS_SCANNED': false})

query I
SELECT current_setting('custom_profiling_settings');
----
{"QUERY_NAME": "true", "EXTRA_INFO": "true"}

# Set metrics from LIST
statement ok
CALL enable_profiling(metrics = ['LATENCY', 'RESULT_SET_SIZE']);

query I
SELECT current_setting('custom_profiling_settings');
----
{"LATENCY": "true", "RESULT_SET_SIZE": "true"}

# Can't mix types though
statement error
CALL enable_profiling(metrics = ['LATENCY', 'RESULT_SET_SIZE' = true]);
----
Conversion Error: 

statement error
CALL enable_profiling(metrics = 'QUERY_NAME': true, 'EXTRA_INFO': true, 'OPERATOR_ROWS_SCANNED': false, "CUMULATIVE_CARDINALITY": "true");
----
Parser Error:

statement ok
RESET custom_profiling_settings;

query I
SELECT current_setting('custom_profiling_settings');
----
{"WRITE_TO_WAL_LATENCY": "true", "WAL_REPLAY_ENTRY_COUNT": "true", "WAITING_TO_ATTACH_LATENCY": "true", "TOTAL_MEMORY_ALLOCATED": "true", "TOTAL_BYTES_WRITTEN": "true", "TOTAL_BYTES_READ": "true", "SYSTEM_PEAK_TEMP_DIR_SIZE": "true", "SYSTEM_PEAK_BUFFER_MEMORY": "true", "ROWS_RETURNED": "true", "RESULT_SET_SIZE": "true", "QUERY_NAME": "true", "OPERATOR_NAME": "true", "OPERATOR_CARDINALITY": "true", "OPERATOR_ROWS_SCANNED": "true", "CPU_TIME": "true", "LATENCY": "true", "COMMIT_LOCAL_STORAGE_LATENCY": "true", "EXTRA_INFO": "true", "CHECKPOINT_LATENCY": "true", "BLOCKED_THREAD_TIME": "true", "OPERATOR_TYPE": "true", "CUMULATIVE_ROWS_SCANNED": "true", "ATTACH_REPLAY_WAL_LATENCY": "true", "OPERATOR_TIMING": "true", "CUMULATIVE_CARDINALITY": "true", "ATTACH_LOAD_STORAGE_LATENCY": "true"}

# Set metrics straight into function
statement ok
CALL enable_profiling(['LATENCY', 'RESULT_SET_SIZE']);

query I
SELECT current_setting('custom_profiling_settings');
----
{"LATENCY": "true", "RESULT_SET_SIZE": "true"}

# Set metrics straight into function with other settings too
statement ok
CALL enable_profiling(['LATENCY', 'RESULT_SET_SIZE'], mode = 'detailed');

query I
SELECT current_setting('custom_profiling_settings');
----
{"LATENCY": "true", "RESULT_SET_SIZE": "true"}

query I
SELECT current_setting('profiling_mode');
----
detailed
