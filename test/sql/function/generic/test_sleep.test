# name: test/sql/function/generic/test_sleep.test
# description: Test sleep_ms function
# group: [generic]

# Test basic sleep function - should return NULL
query T
SELECT sleep_ms(10)
----
NULL

# Test sleep with 0 milliseconds
query T
SELECT sleep_ms(0)
----
NULL

# Test sleep with NULL input
query T
SELECT sleep_ms(NULL)
----
NULL

# Test sleep in a query with timing
query ITI
SELECT 1, sleep_ms(50), 2
----
1	NULL	2

# Test sleep with different values
query T
SELECT sleep_ms(100)
----
NULL

# Test sleep in WHERE clause (should still execute)
query I
SELECT 42 WHERE sleep_ms(10) IS NULL
----
42

# Test sleep with multiple rows
query T
SELECT sleep_ms(10) FROM range(3)
----
NULL
NULL
NULL

# Test sleep with expression
query T
SELECT sleep_ms(10 + 20)
----
NULL

# Test sleep with negative value (should still work, but sleep for 0 or handle gracefully)
query T
SELECT sleep_ms(-10)
----
NULL

# Test sleep_ms over a table
statement ok
CREATE TABLE test_sleep_table AS SELECT * FROM range(5) tbl(id);

query IT
SELECT id, sleep_ms(10) FROM test_sleep_table ORDER BY id
----
0	NULL
1	NULL
2	NULL
3	NULL
4	NULL

# Test sleep_ms with aggregation over a table
query IT
SELECT id, sleep_ms(20) FROM test_sleep_table WHERE id < 3 ORDER BY id
----
0	NULL
1	NULL
2	NULL

# Test sleep_ms timing with JSON profiling - extract and validate actual timing
# For 50ms sleep, we expect to see at least 0.04s (40ms) in the operator_timing
require json

statement ok
PRAGMA enable_profiling = 'json'

statement ok
PRAGMA profiling_output = '__TEST_DIR__/sleep_profiling.json'

statement ok
SELECT sleep_ms(50) FROM range(1)

statement ok
PRAGMA disable_profiling

# Extract timing from JSON profiling output and validate it's >= 0.04s
statement ok
CREATE OR REPLACE TABLE sleep_profiling AS SELECT * FROM read_json('__TEST_DIR__/sleep_profiling.json')

query T
SELECT cpu_time >= 0.05 FROM sleep_profiling WHERE contains(extra_info, 'sleep_ms') OR contains(query_name, 'sleep_ms') LIMIT 1
----
true

statement ok
DROP TABLE sleep_profiling

# Test sleep_ms timing over multiple rows - should take cumulative time
# For 5 rows of 10ms each (50ms total), we expect to see at least 0.04s in the timing
statement ok
PRAGMA enable_profiling = 'json'

statement ok
PRAGMA profiling_output = '__TEST_DIR__/sleep_profiling_multi.json'

statement ok
SELECT sleep_ms(10) FROM range(5)

statement ok
PRAGMA disable_profiling

# Extract timing from JSON profiling output and validate it's >= 0.04s
statement ok
CREATE OR REPLACE TABLE sleep_profiling_multi AS SELECT * FROM read_json('__TEST_DIR__/sleep_profiling_multi.json')

query T
SELECT cpu_time >= 0.04 FROM sleep_profiling_multi WHERE contains(extra_info, 'sleep_ms') OR contains(query_name, 'sleep_ms') LIMIT 1
----
true

statement ok
DROP TABLE sleep_profiling_multi

statement ok
DROP TABLE test_sleep_table

# Test pg_sleep function (Postgres compatibility - takes seconds, converts to milliseconds)
# Test basic pg_sleep function - should return NULL
query T
SELECT pg_sleep(0.1)
----
NULL

# Test pg_sleep with 0 seconds
query T
SELECT pg_sleep(0)
----
NULL

# Test pg_sleep with NULL input
query T
SELECT pg_sleep(NULL)
----
NULL

# Test pg_sleep with fractional seconds
query T
SELECT pg_sleep(0.05)
----
NULL

# Test pg_sleep with 1 second
query T
SELECT pg_sleep(1.0)
----
NULL

# Test pg_sleep in a query with other columns
query ITI
SELECT 1, pg_sleep(0.1), 2
----
1	NULL	2

# Test pg_sleep in WHERE clause (should still execute)
query I
SELECT 42 WHERE pg_sleep(0.1) IS NULL
----
42

# Test pg_sleep with multiple rows
query T
SELECT pg_sleep(0.01) FROM range(3)
----
NULL
NULL
NULL

# Test pg_sleep with expression
query T
SELECT pg_sleep(0.05 + 0.05)
----
NULL

# Test pg_sleep with negative value (should still work, but sleep for 0 or handle gracefully)
query T
SELECT pg_sleep(-0.1)
----
NULL

