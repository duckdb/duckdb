# name: test/sql/function/string/test_string_split.test
# description: String split test
# group: [string]

statement ok
PRAGMA enable_verification

query T
select string_split('babcb', 'b');
----
[, a, c, ]

query T
select UNNEST(string_split('abc', ','))
----
abc

query T
select UNNEST(string_split('1,2,3,4,,6', ','))
----
1
2
3
4
(empty)
6

query T
select UNNEST(string_split('1|2|3', '|'))
----
1
2
3

query T
select UNNEST(string_split('1|2|3|', '|'))
----
1
2
3
(empty)

query T
select UNNEST(string_split('1||2|3||', '||'))
----
1
2|3
(empty)

query T
SELECT * FROM (VALUES (string_split('hello world', ' ')), (string_split(NULL, ' ')), (string_split('', ' ')), (string_split('a b c', NULL)), (string_split('a b c', ' '))) tbl(i)
----
[hello, world]
NULL
[]
[a b c]
[a, b, c]

statement ok
CREATE TABLE strings_with_null (s VARCHAR)

statement ok
INSERT INTO strings_with_null VALUES ('aba'), (NULL), ('ababa')

query T
SELECT UNNEST(string_split(s, 'b')) FROM strings_with_null
----
a
a
a
a
a

query T
SELECT UNNEST(string_split(NULL, ' ')) IS NULL LIMIT 5
----

query T
SELECT UNNEST(string_split('Ã¼Ã¼Ã¼Ã¼Ã¼', 'â—ŒÌˆ'))
----
Ã¼Ã¼Ã¼Ã¼Ã¼

query T
SELECT UNNEST(string_split('Ã¼Ã¼Ã¼Ã¼Ã¼', 'â—Œ'))
----
Ã¼Ã¼Ã¼Ã¼Ã¼

query T
SELECT UNNEST(string_split(' ğŸ¦†ğŸ¦†  ğŸ¦†ğŸ¦†', '  '))
----
 ğŸ¦†ğŸ¦†
ğŸ¦†ğŸ¦†

query T
SELECT UNNEST(string_split('a a a a a', ' '))
----
a
a
a
a
a

query T
SELECT UNNEST(string_split('ğŸ¦† ğŸ¦† ğŸ¦† ğŸ¦† ğŸ¦†', ' '))
----
ğŸ¦†
ğŸ¦†
ğŸ¦†
ğŸ¦†
ğŸ¦†

query T
SELECT UNNEST(string_split('ğŸ¦†ğŸˆğŸˆğŸ¦†ğŸˆğŸˆğŸ¦†ğŸˆğŸˆğŸ¦†ğŸˆğŸˆğŸ¦†', 'ğŸˆğŸˆ'))
----
ğŸ¦†
ğŸ¦†
ğŸ¦†
ğŸ¦†
ğŸ¦†

query T
SELECT UNNEST(string_split('', 'delim'))
----
(empty)

query T
SELECT UNNEST(string_split('ğŸ¦†ğŸ¦†ğŸ¦†ğŸ¦†ğŸ¦†', ''))
----
ğŸ¦†ğŸ¦†ğŸ¦†ğŸ¦†ğŸ¦†

query T
SELECT UNNEST(string_split('ğŸ¦†bğŸ¦†b', 'b'))
----
ğŸ¦†
ğŸ¦†
(empty)

statement ok
CREATE TABLE documents(s VARCHAR)

statement ok
INSERT INTO documents VALUES ('baabbaa'), ('aabbaab'), ('ababababa'), ('bğŸ¦†ğŸ¦†bbğŸ¦†ğŸ¦†'), ('ğŸ¦†ğŸ¦†bbğŸ¦†ğŸ¦†b'), ('ğŸ¦†bğŸ¦†bğŸ¦†bğŸ¦†bğŸ¦†')

query T
SELECT UNNEST(string_split(s, 'bb')) FROM documents WHERE 1
----
baa
aa
aa
aab
ababababa
bğŸ¦†ğŸ¦†
ğŸ¦†ğŸ¦†
ğŸ¦†ğŸ¦†
ğŸ¦†ğŸ¦†b
ğŸ¦†bğŸ¦†bğŸ¦†bğŸ¦†bğŸ¦†

query T
SELECT UNNEST(string_split(s, 'bb')) FROM documents WHERE s LIKE 'b%'
----
baa
aa
bğŸ¦†ğŸ¦†
ğŸ¦†ğŸ¦†

query T
SELECT string_agg(ss, 'bb') FROM (SELECT rowid AS id, UNNEST(string_split(s, 'bb')) AS ss FROM documents) AS q GROUP BY id ORDER BY id
----
baabbaa
aabbaab
ababababa
bğŸ¦†ğŸ¦†bbğŸ¦†ğŸ¦†
ğŸ¦†ğŸ¦†bbğŸ¦†ğŸ¦†b
ğŸ¦†bğŸ¦†bğŸ¦†bğŸ¦†bğŸ¦†

# empty string delimeter
query T
SELECT UNNEST(string_split('abcde', ''))
----
abcde

# test unnesting of null values a bit
query T
SELECT string_split(NULL, NULL)
----
NULL

query T
SELECT string_split('', NULL)
----
[]

query T
SELECT string_split(NULL, '')
----
NULL

query T
SELECT string_split('', NULL)
----
[]

query T
select UNNEST(string_split('1|2|3', NULL))
----
1|2|3

query T
select string_split(NULL, '|') IS NULL
----
1

query T
SELECT string_split('', '')
----
[]

# test incorrect usage
statement error
select string_split()
----

statement error
select string_split('a')
----


# regexp string split
query T
select string_split_regex('babcb', 'b');
----
[, a, c, ]

query T
select UNNEST(string_split_regex('abcd', '(b)'));
----
a
cd

query T
SELECT string_split_regex('a a a a a', ' ')
----
[a, a, a, a, a]

query T
SELECT UNNEST(string_split_regex('a1a11a111a', '[0-9]+'))
----
a
a
a
a

query T
select UNNEST(string_split_regex('a1b', '\d'))
----
a
b

query T
select UNNEST(string_split_regex('a1b', '\\d'))
----
a1b

query T
select UNNEST(string_split_regex('a1b', '(\d)'))
----
a
b

query T
select UNNEST(string_split_regex('a1b', e'\d'))
----
a1b

query T
select UNNEST(string_split_regex('xyz', '[x]'))
----
(empty)
yz

query T
select UNNEST(string_split_regex('wÎ©Î½', '[^\p{Greek}]'))
----
(empty)
Î©Î½

query T
select UNNEST(string_split_regex('1|2|3', '|'))
----
1
|
2
|
3

query T
SELECT UNNEST(string_split_regex('Ã¼Ã¼Ã¼Ã¼Ã¼', 'â—ŒÌˆ'))
----
Ã¼Ã¼Ã¼Ã¼Ã¼

query T
SELECT UNNEST(string_split_regex('Ã¼Ã¼Ã¼Ã¼Ã¼', 'â—Œ'))
----
Ã¼Ã¼Ã¼Ã¼Ã¼

# empty string regex patterns
query T
SELECT string_split_regex('a', '')
----
[a]

query T
SELECT string_split_regex('abc', '')
----
[a, b, c]


query T
SELECT string_split_regex('abc', '^a|^ab')
----
[, bc]


query T
SELECT UNNEST(string_split_regex('ğŸ¦†', ''))
----
ğŸ¦†

query T
SELECT UNNEST(string_split_regex('ğŸ¦†ğŸ¦†ğŸ¦†ğŸ¦†ğŸ¦†', ''))
----
ğŸ¦†
ğŸ¦†
ğŸ¦†
ğŸ¦†
ğŸ¦†

query T
SELECT string_split_regex('âˆ¯', '')
----
[âˆ¯]

# ^ matches empty string at beginning of text
query T
SELECT string_split_regex('ab', '^\w')
----
[, b]

query T
SELECT string_split_regex('ab', '^')
----
[ab]

# $ matches empty string at end of text (like \z not \Z)
query T
SELECT string_split_regex('ab', '\w$')
----
[a, ]

query T
SELECT string_split_regex('ab', '$')
----
[ab]

# \A  matches at beginning of text
query T
SELECT UNNEST(string_split_regex('ab cd', '\A\w'))
----
(empty)
b cd

query T
SELECT UNNEST(string_split_regex('ab cd', '\A'))
----
ab cd

# \b matches ASCII word boundary
query T
select string_split_regex('ab cd', '\b');
----
[ab,  , cd]

query T
select UNNEST(string_split_regex('ab cd', '\\b'));
----
ab cd

# \B matches not at ASCII word boundary
query T
SELECT UNNEST(string_split_regex('ab cd', '\B'))
----
a
b c
d

query T
select string_split_regex('\bhello\b', '\b');
----
[\, bhello, \, b]

query T
select string_split('\bhello\b', '\b');
----
[, hello, ]

query T
select UNNEST(string_split_regex('\bhello\b', '\\b'));
----
(empty)
hello
(empty)

query T
SELECT UNNEST(string_split_regex('ab cd', '\b(\w+)\b'));
----
(empty)
 
(empty)

# \z matches empty string at end of text
query T
SELECT UNNEST(string_split_regex('aaa', '\w\z'))
----
aa
(empty)

query T
SELECT UNNEST(string_split_regex('aaaaa', '\z'))
----
aaaaa

# \y - (not supported)
statement error
select UNNEST(string_split_regex('ab cd', '\y'));
----
Invalid Input Error: invalid escape sequence: \y

# \Z - (not supported)
statement error
SELECT UNNEST(string_split_regex('aaaaa', '\Z'))
----
Invalid Input Error: invalid escape sequence: \Z

# \g - (not supported)
statement error
SELECT UNNEST(string_split_regex('ab cd', '\g'))
----
Invalid Input Error: invalid escape sequence: \g

# \G - (not supported)
statement error
SELECT UNNEST(string_split_regex('ab cd', '\G'))
----
Invalid Input Error: invalid escape sequence: \G

query T
SELECT UNNEST(string_split_regex('ğŸ¦†ağŸ¦†a', 'a'))
----
ğŸ¦†
ğŸ¦†
(empty)

query T
SELECT UNNEST(string_split_regex('ğŸ¦†', 'ğŸ¦†'))
----
(empty)
(empty)

query T
SELECT UNNEST(string_split_regex('a a  a   a', '\s+'))
----
a
a
a
a

query T
select UNNEST(string_split_regex('abc', '(|abc)'))
----
a
b
c

query T
select UNNEST(string_split_regex('abc', '(abc|)'))
----
(empty)
(empty)

query T
select UNNEST(string_split_regex('abc', '(,|abc)'))
----
(empty)
(empty)

query T
select UNNEST(string_split_regex('abc', '(abc|,)'))
----
(empty)
(empty)

query T
select UNNEST(string_split_regex('1,2,3,4,,6', '(,|)'))
----
1
(empty)
2
(empty)
3
(empty)
4
(empty)
(empty)
6

query T
select UNNEST(string_split_regex('1,2,3,4,,6', '(|,)'))
----
1
,
2
,
3
,
4
,
,
6

query T
select UNNEST(string_split_regex('1,2,3,4,*,6', '(,|\*)'))
----
1
2
3
4
(empty)
(empty)
6

query T
select UNNEST(string_split_regex('1,2,3,4,*,6', '(\*|,)'))
----
1
2
3
4
(empty)
(empty)
6

query T
SELECT UNNEST(string_split_regex('', ''))
----
(empty)

# test incorrect regex
statement error
SELECT string_split_regex(a, '[') FROM test ORDER BY a;
----
