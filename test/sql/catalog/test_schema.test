# name: test/sql/catalog/test_schema.test
# description: Schema creation/deletion with transactions
# group: [catalog]

statement ok
SET immediate_transaction_mode=true

# create a schema with a table
statement ok con1
CREATE SCHEMA test;

statement ok con1
CREATE OR REPLACE SCHEMA test;

statement ok con1
CREATE TABLE test.hello(i INTEGER);

statement error con1
CREATE OR REPLACE SCHEMA test;
----
table "hello" depends on schema "test".

# in one transaction drop the table and then the schema (without cascade)
statement ok con1
BEGIN TRANSACTION;

statement ok con1
DROP TABLE test.hello;

statement ok con1
DROP SCHEMA test;

statement ok con1
COMMIT;

# now work with multiple connections
# create the same schema
statement ok con1
CREATE SCHEMA test;

statement ok con1
CREATE TABLE test.hello(i INTEGER);

statement ok con1
INSERT INTO test.hello VALUES (2), (3), (4)

# begin the transactions
statement ok con1
BEGIN TRANSACTION

statement ok con2
BEGIN TRANSACTION

# con1 drops the schema and commits it
statement ok con1
DROP TABLE test.hello;

statement ok con1
DROP SCHEMA test;

statement ok con1
COMMIT;

# con2 queries the schema (should still work)
query I con2
SELECT * FROM test.hello
----
2
3
4

# now con2 finishes the transaction and tries again
statement ok con2
ROLLBACK;

statement error con2
SELECT * FROM test.hello
----
Catalog Error: Catalog with name test does not exist and there is no test schema in the current catalog!

# Test that querying a table in a non-existent schema gives schema error, not table error
statement error
SELECT COUNT(*) FROM non_exist_schema.data
----
Catalog Error: Catalog with name non_exist_schema does not exist and there is no non_exist_schema schema in the current catalog!

# Test with SET catalog_error_max_schemas = 0
statement ok
SET catalog_error_max_schemas = 0;

statement error
SELECT COUNT(*) FROM nonexistent_schema.some_table
----
Catalog Error: Catalog with name nonexistent_schema does not exist and there is no nonexistent_schema schema in the current catalog!

# Test case: Catalog exists but schema does not exist
# Attach a database catalog
statement ok
ATTACH ':memory:' AS test_catalog;

# Create a table in the default schema (main) of the attached catalog
statement ok
CREATE TABLE test_catalog.main.existing_table(i INTEGER);

# Querying a non-existent schema in an existing catalog should give schema error
statement error
SELECT COUNT(*) FROM test_catalog.nonexistent_schema.some_table
----
Catalog Error: Catalog with name nonexistent_schema does not exist and there is no nonexistent_schema schema in the current catalog!

# Querying a non-existent table in an existing schema should give table error (not schema error)
statement error
SELECT COUNT(*) FROM test_catalog.main.nonexistent_table
----
Catalog Error: Table with name nonexistent_table does not exist!

# Test with a fully qualified name where catalog exists, schema doesn't
statement error
SELECT * FROM test_catalog.missing_schema.missing_table
----
Catalog Error: Catalog with name missing_schema does not exist and there is no missing_schema schema in the current catalog!

# Test with different catalog name
statement ok
ATTACH ':memory:' AS another_catalog;

statement error
SELECT COUNT(*) FROM another_catalog.invalid_schema.table_name
----
Catalog Error: Catalog with name invalid_schema does not exist and there is no invalid_schema schema in the current catalog!

# Cleanup
statement ok
DETACH test_catalog;

statement ok
DETACH another_catalog;
