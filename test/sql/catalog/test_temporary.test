# name: test/sql/catalog/test_temporary.test
# description: Test temporary catalog entry creation
# group: [catalog]

# basic temp table creation works
statement ok
CREATE TEMPORARY TABLE integers(i INTEGER) ON COMMIT PRESERVE ROWS

# we can (but never are required to) prefix temp tables with "temp" schema
statement ok
CREATE TEMPORARY TABLE integersx(i INTEGER)

# we don't support temporary schemas (yet?)
#statement error
#CREATE TEMPORARY SCHEMA asdf

# we can prefix temp tables with a schema that is not "temp"
statement ok
CREATE TEMPORARY TABLE main.integersy(i INTEGER)

statement ok
CREATE TEMPORARY TABLE s1 AS SELECT 42

query I
SELECT * FROM temp.s1
----
42

query I
SELECT * FROM s1
----
42

statement error
CREATE TABLE temp.integersy(i INTEGER)
----
<REGEX>:.*Parser Error.*Only TEMPORARY.*

statement ok
CREATE SCHEMA temp

statement error
CREATE TABLE temp.integersy(i INTEGER)
----
<REGEX>:.*Binder Error.*Ambiguous reference.*

statement ok
CREATE TABLE memory.temp.integersy(i INTEGER)

statement ok
DROP SCHEMA temp CASCADE

statement error
DROP TABLE memory.main.integersx
----
<REGEX>:.*Catalog Error.*does not exist.*

statement ok
DROP TABLE integersx

statement ok
CREATE TEMPORARY TABLE temp.integersx(i INTEGER)

statement ok
DROP TABLE temp.integersx

# unsupported
statement error
CREATE TEMPORARY TABLE integers2(i INTEGER) ON COMMIT DELETE ROWS
----
<REGEX>:.*Not implemented Error: Only ON COMMIT.*

# temp table already exists
statement error
CREATE TEMPORARY TABLE integers(i INTEGER)
----
<REGEX>:.*Catalog Error.*already exists.*

statement ok
INSERT INTO integers VALUES (42)

query I
SELECT i from integers
----
42

# temp table survives commit
statement ok
BEGIN TRANSACTION

statement ok
CREATE TEMPORARY TABLE integers2(i INTEGER)

statement ok
CREATE TEMPORARY SEQUENCE seq

statement ok
CREATE TEMPORARY VIEW v1 AS SELECT 42

statement ok
INSERT INTO integers2 VALUES (42)

query I
SELECT i from integers2
----
42

query I
SELECT nextval('seq')
----
1

query I
SELECT * from v1
----
42

statement ok
COMMIT

query I
SELECT i from integers2
----
42

query I
SELECT nextval('seq')
----
2

query I
SELECT * from v1
----
42

# temp table does not survive rollback
statement ok
BEGIN TRANSACTION

statement ok
CREATE TEMPORARY TABLE integers3(i INTEGER)

statement ok
INSERT INTO integers3 VALUES (42)

query I
SELECT i from integers3
----
42

statement ok
ROLLBACK

statement error
SELECT i from integers3
----
<REGEX>:.*Catalog Error.*does not exist.*

# table is not visible to other cons
statement error con2
INSERT INTO integers VALUES (42)
----
<REGEX>:.*Catalog Error.*does not exist.*

# =============================================================================
# Shadowing behavior - temp objects shadow persistent objects with same name
# =============================================================================

# --- Table shadowing ---

statement ok
CREATE TABLE shadow_table(val VARCHAR)

statement ok
INSERT INTO shadow_table VALUES ('persistent')

query I
SELECT * FROM shadow_table
----
persistent

# Create temp table with same name - should shadow persistent
statement ok
CREATE TEMPORARY TABLE shadow_table(val VARCHAR)

statement ok
INSERT INTO shadow_table VALUES ('temporary')

query I
SELECT * FROM shadow_table
----
temporary

# Can still access persistent via explicit catalog
query I
SELECT * FROM memory.main.shadow_table
----
persistent

# Drop temp table
statement ok
DROP TABLE temp.main.shadow_table

# Now query returns persistent version
query I
SELECT * FROM shadow_table
----
persistent

# --- View shadowing ---

statement ok
CREATE VIEW shadow_view AS SELECT 'persistent' AS src

query I
SELECT * FROM shadow_view
----
persistent

# Create temp view with same name - should shadow persistent
statement ok
CREATE TEMPORARY VIEW shadow_view AS SELECT 'temporary' AS src

query I
SELECT * FROM shadow_view
----
temporary

# Can still access persistent via explicit catalog
query I
SELECT * FROM memory.main.shadow_view
----
persistent

# Drop temp view
statement ok
DROP VIEW temp.main.shadow_view

# Now query returns persistent version
query I
SELECT * FROM shadow_view
----
persistent