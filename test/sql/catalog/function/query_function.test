# name: test/sql/catalog/function/query_function.test
# description: test query() function
# group: [function]

statement ok
PRAGMA enable_verification

query I
SELECT * FROM query('SELECT 42');
----
42

query I
FROM query('SELECT 42 as a');
----
42

query I
FROM query('SELECT 10 + 32;');
----
42

query I
FROM query('SELECT abs(-42)');
----
42

query I
SELECT * FROM query('SELECT * FROM (SELECT 1 + 2)');
----
3

query III
FROM query('SELECT 1, 2, 3');
----
1	2	3

query I
FROM query('SELECT 42;;;--- hello;');
----
42

# query text
query I
SELECT 'hello';
----
hello

query I
SELECT * FROM query('SELECT ''hello''');
----
hello

# query from table
statement ok
CREATE TABLE tbl (a INT, b INT);

statement ok
FROM query('SELECT *, 1 + 2 FROM tbl');

statement ok
CREATE TABLE tbl2 (a INT, b INT, c INT);

statement ok
INSERT INTO tbl2 VALUES (1, 2, 3), (4, 5, 6), (7, 8, 9);

query III
SELECT * FROM query('FROM tbl2');
----
1	2	3
4	5	6
7	8	9

query I
SELECT * FROM query('SELECT a + b + c FROM tbl2');
----
6
15
24

# query multiple nested type tags
query II
SELECT * FROM query('WITH a(i) as (SELECT 1) SELECT a1.i as i1, a2.i as i2 FROM a as a1, a as a2');
----
1	1

# test incorrect usage
statement error
SELECT * FROM query(NULL);
----
Parser Error: syntax error at or near "NULL"

statement error
SELECT * FROM query(' ');
----
Parser Error: Expected a single SELECT statement

statement error
SELECT * FROM query('');
----
Parser Error: Expected a single SELECT statement

statement error
SELECT * FROM query('FROM query(FROM)');
----
Parser Error: syntax error at or near "FROM"

# multiple statements are not supported
statement error
SELECT * FROM query('SELECT 1; SELECT 2');
----
Parser Error: Expected a single SELECT statement

# syntax error
statement error
SELECT query(SELECT 1);
----
Parser Error: syntax error at or near "SELECT"

statement error
SELECT * FROM query('CREATE TABLE tbl (a INT)');
----
Parser Error: Expected a single SELECT statement


# test query_table()
query III
from query_table(tbl2);
----
1	2	3
4	5	6
7	8	9

statement ok
create table t_int as select 42;

statement ok
create table t_varchar as select 'duckdb';

statement ok
create table t_empty as select '';

statement ok
create table t2_varchar as select '1?ch@racter$';

query I
from query_table('t_int');
----
42

query I
from query_table(['t_int']);
----
42

query I
from query_table(['t_int', t2_varchar]);
----
42
1?ch@racter$

query I
from query_table('(select 17 + 25)');
----
42

query I
from query_table(['t_int', 't_varchar', 't_empty', t2_varchar, '(select ''I am a subquery'')']);
----
42
duckdb
(empty)
1?ch@racter$
I am a subquery

# test incorrect usage
statement error
from query_table([]);
----
Binder Error: No function matches the given name and argument types 'query_table(INTEGER[])'.

statement error
from query_table(['']);
----
Parser Error: syntax error at end of input

statement error
from query_table('t_int', 't_varchar', t2_varchar);
----
Binder Error: No function matches the given name and argument types 'query_table(VARCHAR, VARCHAR, VARCHAR)'.

statement error
from query_table([t_int, tbl2]);
----
Binder Error: Set operations can only apply to expressions with the same number of result columns

statement error
from query_table(not_defined_tbl);
----
Catalog Error: Table with name not_defined_tbl does not exist!

statement error
from query_table();
----
No function matches the given name and argument types 'query_table()'.

statement error
from query_table(NULL);
----
Parser Error: syntax error at or near "NULL"

# test by_name argument
query I
from query_table(['t_int', 't_varchar', 't_empty', t2_varchar, '(select ''I am a subquery'')'], false);
----
42
duckdb
(empty)
1?ch@racter$
I am a subquery

query IIIII
from query_table(['t_int', 't_varchar', 't_empty', t2_varchar, '(select ''I am a subquery'')'], true);
----
42	NULL	NULL	NULL	NULL
NULL	duckdb	NULL	NULL	NULL
NULL	NULL	(empty)	NULL	NULL
NULL	NULL	NULL	1?ch@racter$	NULL
NULL	NULL	NULL	NULL	I am a subquery

# test incorrect usage
statement error
from query_table(true);
----
Binder Error: No function matches the given name and argument types 'query_table(BOOLEAN)'.

statement error
from query_table(tbl2, true);
----
Binder Error: No function matches the given name and argument types 'query_table(VARCHAR, BOOLEAN)'.
