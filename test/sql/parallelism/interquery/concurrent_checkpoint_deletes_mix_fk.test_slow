# name: test/sql/parallelism/interquery/concurrent_checkpoint_deletes_mix_fk.test_slow
# description: Test concurrent checkpoints while deleting and inserting
# group: [interquery]

statement ok
ATTACH ':memory:' AS mem

statement ok
SET checkpoint_threshold='1TB'

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET index_scan_max_count=999999999

statement ok
SET index_scan_percentage=1

foreach sleep_time 0 25 50 75 100

statement ok
SET debug_checkpoint_sleep_ms=${sleep_time}

statement ok
ATTACH '__TEST_DIR__/concurrent_checkpoint_deletes_fk${sleep_time}.db' AS concurrent_checkpoint_wal

# work-around for not being able to create fk tables in other databases
statement ok
USE concurrent_checkpoint_wal

statement ok
CREATE TABLE pk_tbl(i INTEGER PRIMARY KEY)

statement ok
CREATE TABLE fk_tbl(i INTEGER REFERENCES pk_tbl(i))

statement ok
USE mem

# before starting the loop insert the data for the first 10 threads
loop threadid 0 11

loop x 0 10

statement ok
INSERT INTO concurrent_checkpoint_wal.pk_tbl SELECT * FROM range((${x} * 2000) + ${threadid} * 100, (${x} * 2000) + (${threadid} + 1) * 100);

endloop

endloop

concurrentloop threadid 0 20

loop x 0 10

# for the last 10 threads - insert the data during the loop
onlyif threadid>10
statement ok
INSERT INTO concurrent_checkpoint_wal.pk_tbl SELECT * FROM range((${x} * 2000) + ${threadid} * 100, (${x} * 2000) + (${threadid} + 1) * 100);

# delete the data
onlyif threadid<>10
statement ok
DELETE FROM concurrent_checkpoint_wal.pk_tbl WHERE i >= (${x} * 2000) + ${threadid} * 100 AND i < (${x} * 2000) + (${threadid} + 1) * 100 AND i%2=0

# inserting in the FK table now fails
onlyif threadid<>10
statement error
INSERT INTO concurrent_checkpoint_wal.fk_tbl SELECT * FROM range((${x} * 2000) + ${threadid} * 100, (${x} * 2000) + (${threadid} + 1) * 100) t(i) WHERE i%2=0;
----
constraint

# we can re-insert the rows
onlyif threadid<>10
statement ok
INSERT INTO concurrent_checkpoint_wal.pk_tbl SELECT * FROM range((${x} * 2000) + ${threadid} * 100, (${x} * 2000) + (${threadid} + 1) * 100) t(i) WHERE i%2=0;

# inserting in the fk table now succeeds
onlyif threadid<>10
statement ok
INSERT INTO concurrent_checkpoint_wal.fk_tbl SELECT * FROM range((${x} * 2000) + ${threadid} * 100, (${x} * 2000) + (${threadid} + 1) * 100) t(i) WHERE i%2=0;

# deleting the rows now fails
onlyif threadid<>10
statement error
DELETE FROM concurrent_checkpoint_wal.pk_tbl WHERE i >= (${x} * 2000) + ${threadid} * 100 AND i < (${x} * 2000) + (${threadid} + 1) * 100 AND i%2=0
----
constraint

endloop

loop x 0 2

onlyif threadid=10
statement ok
CHECKPOINT concurrent_checkpoint_wal

endloop

endloop

query I
SELECT COUNT(*) FROM concurrent_checkpoint_wal.pk_tbl
----
20000

query I
SELECT COUNT(*) FROM concurrent_checkpoint_wal.pk_tbl WHERE i < 19_999
----
19999

query I
SELECT COUNT(*) FROM concurrent_checkpoint_wal.fk_tbl WHERE i < 19_999
----
9500

statement ok
DETACH concurrent_checkpoint_wal

statement ok
ATTACH '__TEST_DIR__/concurrent_checkpoint_deletes_fk${sleep_time}.db' AS concurrent_checkpoint_wal

foreach tbl_name pk_tbl fk_tbl

query I
SELECT CASE WHEN regular_count = index_count THEN NULL ELSE {'regular': regular_count, 'index_count': index_count} END
FROM (
	SELECT (SELECT COUNT(*) FROM concurrent_checkpoint_wal.${tbl_name}) regular_count,
	       (SELECT COUNT(*) FROM concurrent_checkpoint_wal.${tbl_name} WHERE i < 19_999) + (SELECT COUNT(*) FROM concurrent_checkpoint_wal.${tbl_name} WHERE i = 19_999) AS index_count
)
----
NULL

endloop

statement ok
DETACH concurrent_checkpoint_wal

endloop
