# name: test/sql/parallelism/interquery/concurrent_checkpoint_index_single_inserter.test
# description: Test concurrent appends to persistent while checkpointing with an index
# group: [interquery]

statement ok
SET checkpoint_threshold='1TB'

statement ok
PRAGMA disable_checkpoint_on_shutdown

foreach sleep_time 0 25 50 75 100

statement ok
SET debug_checkpoint_sleep_ms=${sleep_time}

statement ok
ATTACH '__TEST_DIR__/concurrent_checkpoint_wal${sleep_time}.db' AS concurrent_checkpoint_wal

statement ok
CREATE TABLE concurrent_checkpoint_wal.integers(i INTEGER PRIMARY KEY)

statement ok
SET index_scan_max_count=999999999

statement ok
SET index_scan_percentage=1

concurrentloop threadid 0 2

loop x 0 50

onlyif threadid=0
statement ok
CHECKPOINT concurrent_checkpoint_wal

endloop

loop x 0 500

onlyif threadid=1
statement ok
INSERT INTO concurrent_checkpoint_wal.integers SELECT * FROM range(${x} * 100, (${x} + 1) * 100);

endloop

endloop

query II
SELECT COUNT(*), SUM(i) FROM concurrent_checkpoint_wal.integers
----
50000	1249975000

statement ok
DETACH concurrent_checkpoint_wal

statement ok
ATTACH '__TEST_DIR__/concurrent_checkpoint_wal${sleep_time}.db' AS concurrent_checkpoint_wal

query II
SELECT COUNT(*), SUM(i) FROM concurrent_checkpoint_wal.integers
----
50000	1249975000

query II
SELECT COUNT(*), SUM(i) FROM concurrent_checkpoint_wal.integers WHERE i <= 49995
----
49996	1249775010

statement error
INSERT INTO concurrent_checkpoint_wal.integers VALUES (4999)
----
Duplicate key

statement ok
DETACH concurrent_checkpoint_wal

endloop
