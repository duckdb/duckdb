# name: test/sql/parallelism/interquery/concurrent_checkpoint_wal_optimistic_index.test_slow
# description: Test concurrent optimistic appends to persistent while checkpointing
# group: [interquery]

statement ok
SET checkpoint_threshold='1TB'

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
SET index_scan_max_count=999999999

statement ok
SET index_scan_percentage=1

statement ok
SET debug_checkpoint_sleep_ms=(random() * 100)::UBIGINT

statement ok
ATTACH '__TEST_DIR__/concurrent_checkpoint_wal${sleep_time}.db' AS concurrent_checkpoint_wal

statement ok
CREATE TABLE concurrent_checkpoint_wal.integers(i INTEGER PRIMARY KEY)

concurrentloop threadid 0 10

loop x 0 10

onlyif threadid<>5
statement ok
INSERT INTO concurrent_checkpoint_wal.integers SELECT * FROM range((10 * ${threadid} + ${x}) * 200_000, (10 * ${threadid} + ${x} + 1) * 200_000);

# inserting the same data conflicts
onlyif threadid<>5
statement error
INSERT INTO concurrent_checkpoint_wal.integers SELECT * FROM range((10 * ${threadid} + ${x}) * 200_000, (10 * ${threadid} + ${x} + 1) * 200_000);
----
key

onlyif threadid<>5
query I
SELECT COUNT(*) FROM  concurrent_checkpoint_wal.integers WHERE i >= (10 * ${threadid} + ${x}) * 200_000 AND i < (10 * ${threadid} + ${x} + 1) * 200_000
----
200000

endloop

onlyif threadid=5
statement ok
CHECKPOINT concurrent_checkpoint_wal

endloop

query II
SELECT COUNT(*), SUM(i) FROM concurrent_checkpoint_wal.integers
----
18000000	177999991000000

statement ok
DETACH concurrent_checkpoint_wal

statement ok
ATTACH '__TEST_DIR__/concurrent_checkpoint_wal${sleep_time}.db' AS concurrent_checkpoint_wal

query II
SELECT COUNT(*), SUM(i) FROM concurrent_checkpoint_wal.integers
----
18000000	177999991000000

query I
SELECT COUNT(*) FROM  concurrent_checkpoint_wal.integers WHERE i < 19999999
----
17999999

statement ok
DETACH concurrent_checkpoint_wal
