# name: test/sql/parallelism/interquery/concurrent_checkpoint_wal.test
# description: Test concurrent appends to persistent while checkpointing
# group: [interquery]

load __TEST_DIR__/concurrent_checkpoint_wal.db

statement ok
SET checkpoint_threshold='1TB'

# no sleep means data loss
# sleep means too much data (caused by checkpoint always checkpointing ALL committed data)
# statement ok
# SET debug_checkpoint_sleep_ms=100

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
CREATE TABLE integers(i INTEGER)

concurrentloop threadid 0 20

loop x 0 10

onlyif threadid<>10
statement ok
INSERT INTO integers SELECT * FROM range(${threadid} * 100, (${threadid} + 1) * 100);

endloop

onlyif threadid=10
statement ok
CHECKPOINT

endloop

query II
SELECT COUNT(*), SUM(i) FROM integers
----
19000	18940500

restart

query II
SELECT COUNT(*), SUM(i) FROM integers
----
19000	18940500
