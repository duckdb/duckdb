# name: test/optimizer/unused_columns/deliver_child_columns.test
# description: deliver child columns in RemoveUnusedColumns optimizer
# group: [unused_columns]

require parquet

statement ok
PRAGMA enable_verification

statement ok
create table t (
	s struct(
		c1 varchar,
		c2 integer
	)
);

statement ok
insert into t values
	(ROW('c1', 1));

statement ok
COPY t TO '__TEST_DIR__/test_structs.parquet'

foreach source t read_parquet('__TEST_DIR__/test_structs.parquet')

# View created without any projection pushdown
statement ok
create or replace view test as
	select
		*
	from ${source};

# Projection on the view performs projection pushdown
query II
explain select
	s.c1
from test;
----
physical_plan	<REGEX>:.*Projections:.*s.c1.*

query I
select s.c1 from test;
----
c1

# View created without projection pushdown, as 's' is projected in full
statement ok
create or replace view test as
	select
		s.c1,
		s.c2,
		s
	from ${source};

# Because the child projection only references certain fields, projection pushdown gets applied regardless
query II
explain select
	s.c2,
	s.c1
from test;
----
physical_plan	<REGEX>:.*Projections:.*s.c1.*

# Even when the struct_extract is nested in another expression, projection pushdown gets applied
query II
explain select
	s.c2,
	upper(s.c1)
from test;
----
physical_plan	<REGEX>:.*Projections:.*s.c1.*

query II
select
	s.c2,
	upper(s.c1)
from test;
----
1	C1

query II
select
	s.c2,
	s.c1
from test;
----
1	c1

# View created with two projections of the full struct
statement ok
create or replace view test as
	select
		s s1,
		s s2
	from ${source};

# Projection pushdown is applied to both 's1' and 's2'
query II
explain select
	s1.c2,
	s2.c1
from test;
----
physical_plan	<REGEX>:.*Projections:.*s.c1.*

query II
select
	s1.c2,
	s2.c1
from test;
----
1	c1

# View created without projection pushdown because of 's'
statement ok
create or replace view test as select
	upper(s.c1),
	s.c2,
	s
from ${source};

# Projection pushdown gets applied because only individual fields are referenced
query II
explain select
	s.c2,
	s.c1
from test;
----
physical_plan	<REGEX>:.*Projections:.*s.c1.*

query II
select
	s.c2,
	s.c1
from test;
----
1	c1

endloop

# Create a table with a STRUCT column and an additional column
statement ok
create table t2 (
	s struct(
		c1 varchar,
		c2 integer
	),
	c3 integer
);

statement ok
insert into t2 values
	(ROW('c1', 2), 3);

statement ok
COPY t2 TO '__TEST_DIR__/test_structs2.parquet'

foreach source t2 read_parquet('__TEST_DIR__/test_structs2.parquet')

query I
select
	pack.c3
from (
	select struct_pack(
		s:=s,
		c3:=c3
	) as pack from ${source}
) as sub;
----
3

query II
explain select
	pack.c3
from (
	select struct_pack(
		s:=s,
		c3:=c3
	) as pack from ${source}
) as sub;
----
physical_plan	<REGEX>:.*Projections:.*s.*c3.*

query II
explain select
	pack.v4,
	pack.v2
from (
	select struct_pack(
		v1:=c3,
		v2:=s.c1,
		v3:='test',
		v4:=s.c2
	) as pack from ${source}
) as sub;
----
physical_plan	<REGEX>:.*Projections:.*s.c1.*s.c2.*

query I
select pack.v2
from (
	select {
		'a': 42,
		'v2': s.c2,
		'b': 21
	} as pack from ${source}
) as sub
----
2

statement ok
CREATE OR REPLACE VIEW vw as select {'a': 21, 'b': 42, 'c': 84} s

query II
select s.a, s.c from (
	select s from vw
)
----
21	84

endloop
