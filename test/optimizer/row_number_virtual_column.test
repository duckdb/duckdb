# name: test/optimizer/row_number_virtual_column.test
# description: Test row_number virtual column
# group: [optimizer]

statement ok
pragma enable_verification;

statement ok
CREATE OR REPLACE TABLE foo AS SELECT range a FROM range(1300000);

# Check that row_number is not accessible
statement error
SELECT a, row_number FROM foo;
----
Binder Error: Referenced column "row_number" not found in FROM clause

statement ok
delete from foo where a < 5000;

query III
select a,rowid, row_number() over() as x from foo order by a desc limit 1;
----
1299999	1299999	1295000

query II
explain select a,rowid, row_number() over() as x from foo order by a desc limit 1;
----
physical_plan	<!REGEX>:.*WINDOW.*

# Test that if the window function is on the LHS we do not rewrite

statement ok
CREATE TABLE test (a INTEGER, b INTEGER);

statement ok
INSERT INTO test VALUES (11, 1), (12, 2), (13, 3);

statement ok
CREATE TABLE test2 (b INTEGER, c INTEGER);

statement ok
INSERT INTO test2 VALUES (1, 10), (1, 20), (2, 30);

query II
explain SELECT t.row_num, t.a, t2.c FROM ( SELECT a, b, ROW_NUMBER() OVER () AS row_num FROM test) t JOIN test2 t2 ON t.b = t2.b;
----
physical_plan	<REGEX>:.*WINDOW.*

statement ok
select setseed(0.1);

statement ok
create or replace table test as select (random()*10)::INT a, (random()*5)::INT b  from range(10);

statement ok
create or replace table test2 as select (random()*100)::INT c, (random()*5)::INT b  from range(10);

# Try with a window function on LHS

query II
explain SELECT t.row_num, t.a, t2.c FROM ( SELECT a, b, ROW_NUMBER() OVER () AS row_num FROM test) t JOIN test2 t2 ON t.b = t2.b limit 10;
----
physical_plan	<REGEX>:.*WINDOW.*

# =================== IGNORE ===================
# BUILD_SIDE_PROBE_SIDE changes the window from RHS to LHS

# Try with a window function on RHS

# query II
# explain SELECT t.a, t.b, t2.row_num, t2.c FROM test t JOIN ( SELECT b, c, ROW_NUMBER() OVER () AS row_num FROM test2) t2 ON t.b = t2.b;
# ----
# physical_plan	<!REGEX>:.*WINDOW.*