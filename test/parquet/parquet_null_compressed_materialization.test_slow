# name: test/parquet/parquet_null_compressed_materialization.test_slow
# description: Test if we can do compressed materialization for all-NULL Parquet columns in a join
# group: [parquet]

require parquet

statement ok
SET preserve_insertion_order=false;

# create a huge Parquet file with mostly NULL in it
statement ok
COPY (
	SELECT
		range pk,
		NULL::VARCHAR c0,
		NULL::VARCHAR c1,
		NULL::VARCHAR c2,
		NULL::VARCHAR c3,
		NULL::VARCHAR c4,
		NULL::VARCHAR c5,
		NULL::VARCHAR c6,
		NULL::VARCHAR c7,
		NULL::VARCHAR c8,
		NULL::VARCHAR c9,
		NULL::VARCHAR c10,
		NULL::VARCHAR c11,
		NULL::VARCHAR c12,
		NULL::VARCHAR c13,
		NULL::VARCHAR c14,
		NULL::VARCHAR c15,
		NULL::VARCHAR c16,
		NULL::VARCHAR c17,
		NULL::VARCHAR c18,
		NULL::VARCHAR c19,
		NULL::VARCHAR c20,
		NULL::VARCHAR c21,
		NULL::VARCHAR c22,
		NULL::VARCHAR c23,
		NULL::VARCHAR c24,
		NULL::VARCHAR c25,
		NULL::VARCHAR c26,
		NULL::VARCHAR c27,
		NULL::VARCHAR c28,
		NULL::VARCHAR c29,
		NULL::VARCHAR c30,
		NULL::VARCHAR c31,
		NULL::VARCHAR c32,
		NULL::VARCHAR c33,
		NULL::VARCHAR c34,
		NULL::VARCHAR c35,
		NULL::VARCHAR c36,
		NULL::VARCHAR c37,
		NULL::VARCHAR c38,
		NULL::VARCHAR c39,
		NULL::VARCHAR c40,
		NULL::VARCHAR c41,
		NULL::VARCHAR c42,
		NULL::VARCHAR c43,
		NULL::VARCHAR c44,
		NULL::VARCHAR c45,
		NULL::VARCHAR c46,
		NULL::VARCHAR c47,
		NULL::VARCHAR c48,
		NULL::VARCHAR c49,
		NULL::VARCHAR c50,
		NULL::VARCHAR c51,
		NULL::VARCHAR c52,
		NULL::VARCHAR c53,
		NULL::VARCHAR c54,
		NULL::VARCHAR c55,
		NULL::VARCHAR c56,
		NULL::VARCHAR c57,
		NULL::VARCHAR c58,
		NULL::VARCHAR c59,
		NULL::VARCHAR c60,
		NULL::VARCHAR c61,
		NULL::VARCHAR c62,
		NULL::VARCHAR c63,
		NULL::VARCHAR c64,
		NULL::VARCHAR c65,
		NULL::VARCHAR c66,
		NULL::VARCHAR c67,
		NULL::VARCHAR c68,
		NULL::VARCHAR c69,
		NULL::VARCHAR c70,
		NULL::VARCHAR c71,
		NULL::VARCHAR c72,
		NULL::VARCHAR c73,
		NULL::VARCHAR c74,
		NULL::VARCHAR c75,
		NULL::VARCHAR c76,
		NULL::VARCHAR c77,
		NULL::VARCHAR c78,
		NULL::VARCHAR c79,
		NULL::VARCHAR c80,
		NULL::VARCHAR c81,
		NULL::VARCHAR c82,
		NULL::VARCHAR c83,
		NULL::VARCHAR c84,
		NULL::VARCHAR c85,
		NULL::VARCHAR c86,
		NULL::VARCHAR c87,
		NULL::VARCHAR c88,
		NULL::VARCHAR c89,
		NULL::VARCHAR c90,
		NULL::VARCHAR c91,
		NULL::VARCHAR c92,
		NULL::VARCHAR c93,
		NULL::VARCHAR c94,
		NULL::VARCHAR c95,
		NULL::VARCHAR c96,
		NULL::VARCHAR c97,
		NULL::VARCHAR c98,
		NULL::VARCHAR c99,
		NULL::VARCHAR c100,
		NULL::VARCHAR c101,
		NULL::VARCHAR c102,
		NULL::VARCHAR c103,
		NULL::VARCHAR c104,
		NULL::VARCHAR c105,
		NULL::VARCHAR c106,
		NULL::VARCHAR c107,
		NULL::VARCHAR c108,
		NULL::VARCHAR c109,
		NULL::VARCHAR c110,
		NULL::VARCHAR c111,
		NULL::VARCHAR c112,
		NULL::VARCHAR c113,
		NULL::VARCHAR c114,
		NULL::VARCHAR c115,
		NULL::VARCHAR c116,
		NULL::VARCHAR c117,
		NULL::VARCHAR c118,
		NULL::VARCHAR c119,
		NULL::VARCHAR c120,
		NULL::VARCHAR c121,
		NULL::VARCHAR c122,
		NULL::VARCHAR c123,
		NULL::VARCHAR c124,
		NULL::VARCHAR c125,
		NULL::VARCHAR c126,
		NULL::VARCHAR c127,
		NULL::VARCHAR c128,
		NULL::VARCHAR c129,
		NULL::VARCHAR c130,
		NULL::VARCHAR c131,
		NULL::VARCHAR c132,
		NULL::VARCHAR c133,
		NULL::VARCHAR c134,
		NULL::VARCHAR c135,
		NULL::VARCHAR c136,
		NULL::VARCHAR c137,
		NULL::VARCHAR c138,
		NULL::VARCHAR c139,
		NULL::VARCHAR c140,
		NULL::VARCHAR c141,
		NULL::VARCHAR c142,
		NULL::VARCHAR c143,
		NULL::VARCHAR c144,
		NULL::VARCHAR c145,
		NULL::VARCHAR c146,
		NULL::VARCHAR c147,
		NULL::VARCHAR c148,
		NULL::VARCHAR c149,
		NULL::VARCHAR c150,
		NULL::VARCHAR c151,
		NULL::VARCHAR c152,
		NULL::VARCHAR c153,
		NULL::VARCHAR c154,
		NULL::VARCHAR c155,
		NULL::VARCHAR c156,
		NULL::VARCHAR c157,
		NULL::VARCHAR c158,
		NULL::VARCHAR c159,
		NULL::VARCHAR c160,
		NULL::VARCHAR c161,
		NULL::VARCHAR c162,
		NULL::VARCHAR c163,
		NULL::VARCHAR c164,
		NULL::VARCHAR c165,
		NULL::VARCHAR c166,
		NULL::VARCHAR c167,
		NULL::VARCHAR c168,
		NULL::VARCHAR c169,
		NULL::VARCHAR c170,
		NULL::VARCHAR c171,
		NULL::VARCHAR c172,
		NULL::VARCHAR c173,
		NULL::VARCHAR c174,
		NULL::VARCHAR c175,
		NULL::VARCHAR c176,
		NULL::VARCHAR c177,
		NULL::VARCHAR c178,
		NULL::VARCHAR c179,
		NULL::VARCHAR c180,
		NULL::VARCHAR c181,
		NULL::VARCHAR c182,
		NULL::VARCHAR c183,
		NULL::VARCHAR c184,
		NULL::VARCHAR c185,
		NULL::VARCHAR c186,
		NULL::VARCHAR c187,
		NULL::VARCHAR c188,
		NULL::VARCHAR c189,
		NULL::VARCHAR c190,
		NULL::VARCHAR c191,
		NULL::VARCHAR c192,
		NULL::VARCHAR c193,
		NULL::VARCHAR c194,
		NULL::VARCHAR c195,
		NULL::VARCHAR c196,
		NULL::VARCHAR c197,
		NULL::VARCHAR c198,
		NULL::VARCHAR c199,
		NULL::VARCHAR c200,
		NULL::VARCHAR c201,
		NULL::VARCHAR c202,
		NULL::VARCHAR c203,
		NULL::VARCHAR c204,
		NULL::VARCHAR c205,
		NULL::VARCHAR c206,
		NULL::VARCHAR c207,
		NULL::VARCHAR c208,
		NULL::VARCHAR c209,
		NULL::VARCHAR c210,
		NULL::VARCHAR c211,
		NULL::VARCHAR c212,
		NULL::VARCHAR c213,
		NULL::VARCHAR c214,
		NULL::VARCHAR c215,
		NULL::VARCHAR c216,
		NULL::VARCHAR c217,
		NULL::VARCHAR c218,
		NULL::VARCHAR c219,
		NULL::VARCHAR c220,
		NULL::VARCHAR c221,
		NULL::VARCHAR c222,
		NULL::VARCHAR c223,
		NULL::VARCHAR c224,
		NULL::VARCHAR c225,
		NULL::VARCHAR c226,
		NULL::VARCHAR c227,
		NULL::VARCHAR c228,
		NULL::VARCHAR c229,
		NULL::VARCHAR c230,
		NULL::VARCHAR c231,
		NULL::VARCHAR c232,
		NULL::VARCHAR c233,
		NULL::VARCHAR c234,
		NULL::VARCHAR c235,
		NULL::VARCHAR c236,
		NULL::VARCHAR c237,
		NULL::VARCHAR c238,
		NULL::VARCHAR c239,
		NULL::VARCHAR c240,
		NULL::VARCHAR c241,
		NULL::VARCHAR c242,
		NULL::VARCHAR c243,
		NULL::VARCHAR c244,
		NULL::VARCHAR c245,
		NULL::VARCHAR c246,
		NULL::VARCHAR c247,
		NULL::VARCHAR c248,
		NULL::VARCHAR c249,
		NULL::VARCHAR c250,
		NULL::VARCHAR c251,
		NULL::VARCHAR c252,
		NULL::VARCHAR c253,
		NULL::VARCHAR c254,
		NULL::VARCHAR c255,
		NULL::VARCHAR c256,
		NULL::VARCHAR c257,
		NULL::VARCHAR c258,
		NULL::VARCHAR c259,
		NULL::VARCHAR c260,
		NULL::VARCHAR c261,
		NULL::VARCHAR c262,
		NULL::VARCHAR c263,
		NULL::VARCHAR c264,
		NULL::VARCHAR c265,
		NULL::VARCHAR c266,
		NULL::VARCHAR c267,
		NULL::VARCHAR c268,
		NULL::VARCHAR c269,
		NULL::VARCHAR c270,
		NULL::VARCHAR c271,
		NULL::VARCHAR c272,
		NULL::VARCHAR c273,
		NULL::VARCHAR c274,
		NULL::VARCHAR c275,
		NULL::VARCHAR c276,
		NULL::VARCHAR c277,
		NULL::VARCHAR c278,
		NULL::VARCHAR c279,
		NULL::VARCHAR c280,
		NULL::VARCHAR c281,
		NULL::VARCHAR c282,
		NULL::VARCHAR c283,
		NULL::VARCHAR c284,
		NULL::VARCHAR c285,
		NULL::VARCHAR c286,
		NULL::VARCHAR c287,
		NULL::VARCHAR c288,
		NULL::VARCHAR c289,
		NULL::VARCHAR c290,
		NULL::VARCHAR c291,
		NULL::VARCHAR c292,
		NULL::VARCHAR c293,
		NULL::VARCHAR c294,
		NULL::VARCHAR c295,
		NULL::VARCHAR c296,
		NULL::VARCHAR c297,
		NULL::VARCHAR c298,
		NULL::VARCHAR c299,
		NULL::VARCHAR c300,
		NULL::VARCHAR c301,
		NULL::VARCHAR c302,
		NULL::VARCHAR c303,
		NULL::VARCHAR c304,
		NULL::VARCHAR c305,
		NULL::VARCHAR c306,
		NULL::VARCHAR c307,
		NULL::VARCHAR c308,
		NULL::VARCHAR c309,
		NULL::VARCHAR c310,
		NULL::VARCHAR c311,
		NULL::VARCHAR c312,
		NULL::VARCHAR c313,
		NULL::VARCHAR c314,
		NULL::VARCHAR c315,
		NULL::VARCHAR c316,
		NULL::VARCHAR c317,
		NULL::VARCHAR c318,
		NULL::VARCHAR c319,
		NULL::VARCHAR c320,
		NULL::VARCHAR c321,
		NULL::VARCHAR c322,
		NULL::VARCHAR c323,
		NULL::VARCHAR c324,
		NULL::VARCHAR c325,
		NULL::VARCHAR c326,
		NULL::VARCHAR c327,
		NULL::VARCHAR c328,
		NULL::VARCHAR c329,
		NULL::VARCHAR c330,
		NULL::VARCHAR c331,
		NULL::VARCHAR c332,
		NULL::VARCHAR c333,
		NULL::VARCHAR c334,
		NULL::VARCHAR c335,
		NULL::VARCHAR c336,
		NULL::VARCHAR c337,
		NULL::VARCHAR c338,
		NULL::VARCHAR c339,
		NULL::VARCHAR c340,
		NULL::VARCHAR c341,
		NULL::VARCHAR c342,
		NULL::VARCHAR c343,
		NULL::VARCHAR c344,
		NULL::VARCHAR c345,
		NULL::VARCHAR c346,
		NULL::VARCHAR c347,
		NULL::VARCHAR c348,
		NULL::VARCHAR c349,
		NULL::VARCHAR c350,
		NULL::VARCHAR c351,
		NULL::VARCHAR c352,
		NULL::VARCHAR c353,
		NULL::VARCHAR c354,
		NULL::VARCHAR c355,
		NULL::VARCHAR c356,
		NULL::VARCHAR c357,
		NULL::VARCHAR c358,
		NULL::VARCHAR c359,
		NULL::VARCHAR c360,
		NULL::VARCHAR c361,
		NULL::VARCHAR c362,
		NULL::VARCHAR c363,
		NULL::VARCHAR c364,
		NULL::VARCHAR c365,
		NULL::VARCHAR c366,
		NULL::VARCHAR c367,
		NULL::VARCHAR c368,
		NULL::VARCHAR c369,
		NULL::VARCHAR c370,
		NULL::VARCHAR c371,
		NULL::VARCHAR c372,
		NULL::VARCHAR c373,
		NULL::VARCHAR c374,
		NULL::VARCHAR c375,
		NULL::VARCHAR c376,
		NULL::VARCHAR c377,
		NULL::VARCHAR c378,
		NULL::VARCHAR c379,
		NULL::VARCHAR c380,
		NULL::VARCHAR c381,
		NULL::VARCHAR c382,
		NULL::VARCHAR c383,
		NULL::VARCHAR c384,
		NULL::VARCHAR c385,
		NULL::VARCHAR c386,
		NULL::VARCHAR c387,
		NULL::VARCHAR c388,
		NULL::VARCHAR c389,
		NULL::VARCHAR c390,
		NULL::VARCHAR c391,
		NULL::VARCHAR c392,
		NULL::VARCHAR c393,
		NULL::VARCHAR c394,
		NULL::VARCHAR c395,
		NULL::VARCHAR c396,
		NULL::VARCHAR c397,
		NULL::VARCHAR c398,
		NULL::VARCHAR c399,
	FROM
		range(600_000)
) TO '{TEMP_DIR}/many_nulls.parquet' (ROW_GROUP_SIZE_BYTES '64mb');

# set a low memory env
statement ok
SET threads=4;

# we creating a build side of approximately:
# uncompressed: 1_200_000 * 400 * 16 = ~8 GB
# uncompressed: 1_200_000 * 400 * 1 = ~0.5 GB
# this memory limit tests if the build side compresses well
statement ok
SET memory_limit='1.5GB';

statement ok
SET temp_directory=NULL

# join, this should take many GBs of memory, but all the NULLs get compressed to UTINYINT so it should fit
# we should see at least 10 compresses in the output (should be 400 but gets truncated)
query II
EXPLAIN ANALYZE SELECT ANY_VALUE(COLUMNS(*))
FROM read_parquet(['{TEMP_DIR}/many_nulls.parquet' for _ in range(2)], union_by_name=true) build
JOIN read_parquet(['{TEMP_DIR}/many_nulls.parquet' for _ in range(3)]) probe
USING (pk)
----
analyzed_plan	<REGEX>:(.*internal_compress_string.*){10,}
