name: Python
on:
  workflow_dispatch:
  repository_dispatch:

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  manylinux-extensions-x64:
    name: Linux Extensions (linux_amd64_gcc4)
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux2014_x86_64
    env:
      GEN: ninja

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: ./.github/actions/manylinux_2014_setup
        with:
          aws-cli: 1
          ninja-build: 1
          ccache: 1
          nodejs: 1
          ssh: 1
          python_alias: 1
          openssl: 1

      - uses: ./.github/actions/build_extensions
        with:
          vcpkg_target_triplet: x64-linux
          post_install: rm build/release/src/libduckdb*
          deploy_as: linux_amd64_gcc4
          s3_id: ${{ secrets.S3_ID }}
          s3_key: ${{ secrets.S3_KEY }}
          signing_pk: ${{ secrets.DUCKDB_EXTENSION_SIGNING_PK }}
          run_tests: 0
          run_autoload_tests: 0
          treat_warn_as_error: 0
          ninja: 1

      - uses: actions/upload-artifact@v3
        with:
          name: manylinux-extensions-x64
          path: |
            build/release/extension/*/*.duckdb_extension